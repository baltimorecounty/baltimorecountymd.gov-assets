!function(){"use strict";angular.module("baltcogoApp",[])}(),function(e){function t(e,t,o){function a(e){var o=t.defer(),a=null,r=null;return n().then(function(t){for(var n=0,i=t.length;n<i;n++)if(r=t[n],e&&e.indexOf(r.animal)>-1){a=r;break}o.resolve(a)}),o.promise}function n(){return e.get("/sebin/u/t/animal-colors.json",{cache:!0}).then(r).catch(i)}function r(e){return e.data}function i(e){o.error("Error: "+e)}return{getAnimalType:a,getBreeds:n}}e.factory("animalService",["$http","$q","$log",t])}(angular.module("baltcoGoApp")),function(e){function t(e,t,o){function a(){return e.get("data/synonyms.json",{cache:!0}).then(n).catch(r)}function n(e){return e.data}function r(e){o.error("Error: "+e)}return{getSynonyms:a}}e.factory("dataService",["$http","$q","$log",t])}(angular.module("baltcoGoApp")),function(e){"use strict";function t(e){function t(e){return e.replace(", USA","")}var o,a="http://bcgis.baltimorecountymd.gov/arcgis/rest/services/Geocoders/AddressPoint_NAD83/GeocodeServer",n=function(e,t){return new google.maps.places.Autocomplete(document.getElementById(e),t)},r=function(e,t){return new google.maps.Map(document.getElementById(e),t)},i=function(e,t,a){o&&o.setMap(null),o=new google.maps.Marker({position:{lat:t,lng:a},map:e,icon:"/sebin/n/f/icon-marker-my-report.png",draggable:!1,animation:google.maps.Animation.DROP})},s=function(e,t,o,n){require(["esri/tasks/Locator","esri/geometry/Point"],function(r,i){var s=new i(t,e),c={countryCode:"US",outSpatialReference:4269,url:a},u=new r(c);u.locationToAddress(s).then(o,n)})},c=function(e,t){require(["esri/tasks/Locator","esri/geometry/Point"],function(o,n){var r={countryCode:"US",outSpatialReference:4269,url:a},i={location:new n(-76.60652470000002,39.4003288),text:e},s={responseType:"json"};new o(r).suggestLocations(i,s).then(function(e){var o=[];angular.forEach(e,function(e){o.push(e.text.toLowerCase())}),t(o)},function(e){console.log("err",e)})})},u=function(e,t){return e.score<t.score?1:e.score>t.score?-1:0};return{addressLookup:function(e,t,o){require(["esri/tasks/Locator"],function(n){var r={countryCode:"US",outSpatialReference:4269,url:a},i={address:{"Single Line Input":e},f:"json"},s={responseType:"json"};new n(r).addressToLocations(i,s).then(function(e){e.length?t(e.sort(u)[0]):o("No location was found for this address.")},o)})},createAutoComplete:n,createMap:r,createMarker:i,pan:function(e,t,o){e.panTo({lat:t,lng:o})},removeCountry:t,reverseGeocode:s,suggestAddresses:c}}e.factory("mapServiceComposite",["$http",t])}(angular.module("baltcogoApp")),function(e){"use strict";function t(e){function t(t,o,a){var n={headers:{"Content-Type":"application/json"}};e.post("//testservices.baltimorecountymd.gov/api/baltcogo/createreport",t,n).then(function(e){o(e.data)},function(e){a(e)})}function o(t,o,a){e.get("//testservices.baltimorecountymd.gov/api/citysourced/getreport/"+t).then(function(e){o(e.data)},function(e){a(e)})}function a(t,o,a){var n={headers:{"Content-Type":"application/json"}};e.post("//testservices.baltimorecountymd.gov/api/citysourced/getreportsbylatlng",t,n).then(function(e){o(e.data)},function(e){a(e)})}return{post:t,getById:o,getNearby:a}}e.factory("reportService",["$http",t])}(angular.module("baltcogoApp")),function(e){function t(e,t){return function(e,t){return e.Fuse?e.Fuse:(t.error("Unable to load the smart search, we probably need to do something else. You probably forgot to include the reference to the fuse library"),null)}(e,t)}e.factory("smartSearch",["$window","$log",t])}(angular.module("baltcogoApp")),function(e,t){"use strict";function o(e,t,o,a,n,r,i,s){function c(e){o(function(){$("#categories").val(B.category),$("#subCategories").val(B.subCategory),e&&t.$apply(function(){$("#pet-type").find("option[selected]").removeAttr("selected").end(),$("#pet-type option[label*='"+e.animal+"' i]").prop("selected",!0),u(e)})},250)}function u(e){B.petType={id:e.id,name:e.animal}}function l(e,t){angular.forEach(B.categoryData,function(o){o.id===e?(B.category=o,B.loadSubCategories(o.id)):o.types&&angular.forEach(o.types,function(a){a.id===e&&(B.category=o.id,B.loadSubCategories(),B.category=o.id,B.subCategory=a.id,c(t))})})}function d(){B.subCategory="",B.petType="",B.otherPetType="",B.petSex="",B.primaryColor="",B.primaryBreed="",B.animalDescription="",B.streetAddress="",B.city="",B.zipCode="",B.descriptionOfAnimalId=0,B.descriptionOfLocationId=0,B.otherDescriptionId=0}function p(e){n.addressLookup(e,function(e){B.latitude=e.location.y,B.longitude=e.location.x,n.pan(x,B.latitude,B.longitude),n.createMarker(x,B.latitude,B.longitude)},function(e){w()})}function m(e,t){var o="";return angular.forEach(e,function(e){if(e.id===t)return o=e.name,!0}),o}function g(){var e=angular.element("#citysourced-reporter-form .panel:visible [required]"),o=e.length,a=e.filter(".ng-valid").length,n=t.citySourcedReporterForm.$$controls;return angular.forEach(n,function(e,t,o){e.$$element.closest(".panel").is(":visible")&&(e.$pristine&&e.$setDirty(),e.$untouched&&e.$setTouched(),e.$$element.is("#address")&&(0!==B.latitude&&0!==B.longitude||e.$setValidity("required",!1)))}),o===a}function f(e){var o=e.which||e.keyCode;if(40===o)return e.preventDefault(),void angular.element(".autocomplete-results button").first().focus();if(13===o){if(B.autocompleteResults.length>0){var a=B.autocompleteResults[0];B.address=a,B.autocompleteResults=[],t.$apply(),p(a)}}else B.address&&B.address.trim().length>3&&n.suggestAddresses(B.address,function(e){B.autocompleteResults=e,t.$apply()})}function y(e){var o=e.which||e.keyCode,a=angular.element(e.target);a.is(".autocomplete-results button")&&(27===o&&angular.element(".autocomplete-results").is(":visible")&&(B.autocompleteResults=[],t.$apply()),e.preventDefault(),13!==o&&32!==o||a.trigger("click"),40===o&&a.parent().next().find("button").focus(),38===o&&a.parent().prev().find("button").focus())}function h(e){B.animalTypeData=e.data}function v(e){B.animalBreedData=e.data}function C(e){B.categoryData=e.data,E&&l(E),b(e.data)}function b(e){s.getSynonyms().then(function(t){B.synonyms=t,e.forEach(S)})}function S(e){var t=[];e.types.forEach(function(e){var o=A(B.synonyms,e);t.push(o)}),B.helpFormattedData=t,D(t)}function D(e){function t(){B.helpQuery=""}function o(e,t){$("#smart-search").typeahead("val",B.helpQuery)}function a(e,o,a){var n=getAnimalType(B.helpQuery);l(o.item.subcategory.id,n),t()}var n=[{name:"subcategory.name",weight:.3},{name:"subcategory.tags",weight:.7}];if(!B.smartSearcher){var r={shouldSort:!0,includeScore:!0,threshold:.6,distance:100,keys:n};B.smartSearcher=new smartSearch(e,r),B.typeAhead=$("#smart-search").typeahead({highlight:!0});$("#smart-search").typeahead({highlight:!0},{source:function(e,t){t(B.smartSearcher.search(e))},templates:{suggestion:function(e){return e=e.item,'<div><p class="text-muted" data-category="'+e.category.id+'" data-id="'+e.subcategory.id+'">'+e.subcategory.name+"</p></div>"},empty:function(){return'<p class="text-muted">No results found.</p>'}}}).on("typeahead:cursorchange",o).on("typeahead:selected",a)}}function A(e,t){var o=T(e,t.name);return o=t.tags?t.tags.concat(o):o,{category:{id:item.id,name:item.name},subcategory:{id:t.id,name:t.name,tags:o}}}function T(e,t){var o=[];return Object.keys(e).forEach(function(a,n){if(t.toLowerCase().indexOf(a)>-1){var r=e[a];o=o.concat(r)}}),o}function L(e){B.animalColorData=e.data}function w(){angular.element("#map").closest("cs-form-control").addClass("error"),t.citySourcedReporterForm.address.$setDirty(),B.address="",t.$apply()}function k(e){console.log(e)}function I(e){var o=angular.element("#map").closest("cs-form-control"),a=t.citySourcedReporterForm.address;B.autocompleteResults=[],B.latitude=e.latLng.lat(),B.longitude=e.latLng.lng(),n.reverseGeocode(B.latitude,B.longitude,function(e){o.removeClass("error"),n.createMarker(x,B.latitude,B.longitude),B.address=e.address.Street.toLowerCase()+", "+e.address.City.toLowerCase()+", "+e.address.State.toUpperCase(),t.$apply()},function(e){o.addClass("error"),a.$setDirty(),B.address="",t.$apply()})}function R(e){B.petTypeData=e.data}function O(e){13===(e.which||e.keyCode)&&e.preventDefault()}var x,B=this,E=a&&a.categoryId?1*a.categoryid:null;animalService.getBreeds().then(v).catch(k),e.get("/sebin/u/t/animal-colors.json").then(L,k),e.get("/sebin/a/d/animal-types.json").then(h,k),e.get("/sebin/q/n/categories.json").then(C,k),e.get("/sebin/m/z/pet-types.json").then(R,k),B.isAnimal=!1,B.page=1,B.isDone=!1,B.isSuccess=!1,B.issueId="",B.isLoading=!1,B.latitude=0,B.longitude=0;var P={center:{lat:39.4003288,lng:-76.60652470000002},scrollwheel:!1,zoom:14,mapTypeId:"roadmap",mapTypeControl:!1,streetViewControl:!1};x=n.createMap("map",P),google.maps.event.addListener(x,"click",I),angular.element("#citysourced-reporter-form").on("keyup keypress",O),angular.element("#address").on("keyup",f),angular.element(window).on("keydown",y),B.fileReportClick=function(){if(g()){var e=[{name:"Category",id:B.category,value:m(B.categoryData,B.category)},{name:"SubCategory",id:B.subCategory,value:m(B.subCategories,B.subCategory)},{name:"Description",id:B.descriptionId,value:B.description},{name:"Latitude",value:B.latitude},{name:"Longitude",value:B.longitude},{name:"FirstName",value:B.firstName},{name:"LastName",value:B.lastName},{name:"Email",value:B.email},{name:"DeviceNumber",value:B.deviceNumber}];if(B.locationDescription&&e.push({name:"Description Of Location",id:B.descriptionOfLocationId,value:B.locationDescription}),B.otherDescription&&e.push({name:"Other Description",id:B.otherDescriptionId,value:B.otherDescription}),B.petType&&e.push({name:"Pet Type",id:B.petType.id,value:m(B.petTypeData,B.petType.id)}),B.petSex&&e.push({name:"Sex",id:B.petSex.id,value:m(B.sex,B.petSex.id)}),B.otherPetType&&e.push({name:"Other Pet Type",id:B.otherPetType,value:m(B.animalTypeData,B.otherPetType)}),B.primaryBreed&&e.push({name:"Primary Breed",id:B.primaryBreed,value:m(B.breeds,B.primaryBreed)}),B.primaryColor&&e.push({name:"Primary Color",id:B.primaryColor,value:m(B.animalColorData,B.primaryColor)}),B.animalDescription&&e.push({name:"Description Of Animal",id:1*angular.element("#animalDescription").attr("data-cs-id"),value:B.animalDescription}),B.streetAddress&&e.push({name:"Complainant Address",id:B.streetAddressId,value:B.streetAddress}),B.city&&e.push({name:"Complainant City",id:B.cityId,value:B.city}),B.state){var t=B.state.id?B.state.id:B.state;e.push({name:"Complainant State",id:t,value:m(B.states,t)})}B.zipCode&&e.push({name:"Complainant Zip Code",id:B.zipCodeId,value:B.zipCode}),B.isLoading=!0,B.isDone=!0,r.post(e,function(e){B.isLoading=!1,B.isSuccess=!0,B.issueId=JSON.parse(e).CsResponse.ReportId},function(e){B.isLoading=!1,console.log(e)})}},B.loadSubCategories=function(){if(!B.category)return void(B.subCategories=[]);angular.forEach(B.categoryData,function(e){d(),e.id==B.category&&(B.subCategories=e.types,e.states?(B.states=e.states,B.state=e.states[0]):B.states=[],e.fields&&(B.streetAddressId=e.fields.streetAddress,B.cityId=e.fields.city,B.zipCodeId=e.fields.zipCode),B.isAnimal="pets and animals"===e.name.toLowerCase(),o(function(){e.descriptionOfAnimal&&(B.descriptionOfAnimalId=e.descriptionOfAnimal),e.descriptionOfLocation&&(B.descriptionOfLocationId=e.descriptionOfLocation),e.otherDescription&&(B.otherDescriptionId=e.otherDescription)},0),B.descriptionId=e.description)})},B.nextClick=function(){g()?2===++B.page&&setTimeout(function(){var e=x.getCenter();google.maps.event.trigger(x,"resize"),x.setCenter(e)},500):t.citySourcedReporterForm.$setSubmitted()},B.prevClick=function(){2===--B.page&&setTimeout(function(){var e=x.getCenter();google.maps.event.trigger(x,"resize"),x.setCenter(e)},500)},B.trackBreed=function(){angular.element.each(B.animalBreedData,function(e,t){if(t.id===B.petType.id)return B.breeds=t.breeds?t.breeds:[],B.sex=t.sex,!0})},B.lookupAddress=function(e){B.autocompleteResults=[],B.address=e,p(e)}}e.controller("BaltCoGoReporterCtrl",["$http","$scope","$timeout","$routeParams","mapServiceComposite","reportService","smartSearch","dataService",o])}(angular.module("baltcogoApp"),baltimoreCounty.utility.querystringer);