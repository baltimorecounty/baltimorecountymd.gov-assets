!function(){"use strict";angular.module("baltcogoApp",["ngRoute"])}(),function(e){function t(e,t,o){function n(e){var o=t.defer(),n=null,r=null;return a().then(function(t){for(var a=0,i=t.length;a<i;a++)if(r=t[a],e&&e.indexOf(r.animal)>-1){n=r;break}o.resolve(n)}),o.promise}function a(){return e.get("/sebin/y/a/animal-breeds.json",{cache:!0}).then(r).catch(i)}function r(e){return e.data}function i(e){o.error("Error: ",e)}return{getAnimalType:n,getBreeds:a}}e.factory("animalService",["$http","$q","$log",t])}(angular.module("baltcogoApp")),function(e){function t(e,t,o){function n(){return e.get("/sebin/c/y/synonyms.json",{cache:!0}).then(a).catch(r)}function a(e){return e.data}function r(e){o.error("Error: ",e)}return{getSynonyms:n}}e.factory("dataService",["$http","$q","$log",t])}(angular.module("baltcogoApp")),function(e){"use strict";function t(e){function t(e){return e.replace(", USA","")}var o,n="http://bcgis.baltimorecountymd.gov/arcgis/rest/services/Geocoders/AddressPoint_NAD83/GeocodeServer",a=function(e,t){return new google.maps.places.Autocomplete(document.getElementById(e),t)},r=function(e,t){return new google.maps.Map(document.getElementById(e),t)},i=function(e,t,n){o&&o.setMap(null),o=new google.maps.Marker({position:{lat:t,lng:n},map:e,icon:"/sebin/n/f/icon-marker-my-report.png",draggable:!1,animation:google.maps.Animation.DROP})},s=function(e,t,o,a){require(["esri/tasks/Locator","esri/geometry/Point"],function(r,i){var s=new i(t,e),c={countryCode:"US",outSpatialReference:4269,url:n},u=new r(c);u.locationToAddress(s).then(o,a)})},c=function(e,t){require(["esri/tasks/Locator","esri/geometry/Point"],function(o,a){var r={countryCode:"US",outSpatialReference:4269,url:n},i={location:new a(-76.60652470000002,39.4003288),text:e},s={responseType:"json"};new o(r).suggestLocations(i,s).then(function(e){var o=[];angular.forEach(e,function(e){o.push(e.text.toLowerCase())}),t(o)},function(e){console.log("err",e)})})},u=function(e,t){return e.score<t.score?1:e.score>t.score?-1:0};return{addressLookup:function(e,t,o){require(["esri/tasks/Locator"],function(a){var r={countryCode:"US",outSpatialReference:4269,url:n},i={address:{"Single Line Input":e},f:"json"},s={responseType:"json"};new a(r).addressToLocations(i,s).then(function(e){e.length?t(e.sort(u)[0]):o("No location was found for this address.")},o)})},createAutoComplete:a,createMap:r,createMarker:i,pan:function(e,t,o){e.panTo({lat:t,lng:o})},removeCountry:t,reverseGeocode:s,suggestAddresses:c}}e.factory("mapServiceComposite",["$http",t])}(angular.module("baltcogoApp")),function(e){"use strict";function t(e){function t(t,o,n){var a={headers:{"Content-Type":"application/json"}};e.post("//testservices.baltimorecountymd.gov/api/baltcogo/createreport",t,a).then(function(e){o(e.data)},function(e){n(e)})}function o(t,o,n){e.get("//testservices.baltimorecountymd.gov/api/citysourced/getreport/"+t).then(function(e){o(e.data)},function(e){n(e)})}function n(t,o,n){var a={headers:{"Content-Type":"application/json"}};e.post("//testservices.baltimorecountymd.gov/api/citysourced/getreportsbylatlng",t,a).then(function(e){o(e.data)},function(e){n(e)})}return{post:t,getById:o,getNearby:n}}e.factory("reportService",["$http",t])}(angular.module("baltcogoApp")),function(e){function t(e,t){return function(e,t){return e.Fuse?e.Fuse:(t.error("Unable to load the smart search, we probably need to do something else. You probably forgot to include the reference to the fuse library"),null)}(e,t)}e.factory("smartSearch",["$window","$log",t])}(angular.module("baltcogoApp")),function(e,t){"use strict";function o(e,t,o,n,a,r,i,s,c,u){function l(e){n(function(){$("#categories").val(P.category),$("#subCategories").val(P.subCategory),e&&t.$apply(function(){$("#pet-type").find("option[selected]").removeAttr("selected").end(),$("#pet-type option[label*='"+e.animal+"' i]").prop("selected",!0),d(e)})},250)}function d(e){P.petType={id:e.id,name:e.animal}}function p(e,t){angular.forEach(P.categoryData,function(o){o.id===e?(P.category=o,P.loadSubCategories(o.id)):o.types&&angular.forEach(o.types,function(n){n.id===e&&(P.category=o.id,P.loadSubCategories(),P.category=o.id,P.subCategory=n.id,l(t))})})}function m(){P.subCategory="",P.petType="",P.otherPetType="",P.petSex="",P.primaryColor="",P.primaryBreed="",P.animalDescription="",P.streetAddress="",P.city="",P.zipCode="",P.descriptionOfAnimalId=0,P.descriptionOfLocationId=0,P.otherDescriptionId=0}function g(e){r.addressLookup(e,function(e){P.latitude=e.location.y,P.longitude=e.location.x,r.pan(E,P.latitude,P.longitude),r.createMarker(E,P.latitude,P.longitude)},function(e){I()})}function f(e,t){var o="";return angular.forEach(e,function(e){if(e.id===t)return o=e.name,!0}),o}function y(){var e=angular.element("#citysourced-reporter-form .panel:visible [required]"),o=e.length,n=e.filter(".ng-valid").length,a=t.citySourcedReporterForm.$$controls;return angular.forEach(a,function(e,t,o){e.$$element.closest(".panel").is(":visible")&&(e.$pristine&&e.$setDirty(),e.$untouched&&e.$setTouched(),e.$$element.is("#address")&&(0!==P.latitude&&0!==P.longitude||e.$setValidity("required",!1)))}),o===n}function h(e){var o=e.which||e.keyCode;if(40===o)return e.preventDefault(),void angular.element(".autocomplete-results button").first().focus();if(13===o){if(P.autocompleteResults.length>0){var n=P.autocompleteResults[0];P.address=n,P.autocompleteResults=[],t.$apply(),g(n)}}else P.address&&P.address.trim().length>3&&r.suggestAddresses(P.address,function(e){P.autocompleteResults=e,t.$apply()})}function v(e){var o=e.which||e.keyCode,n=angular.element(e.target);n.is(".autocomplete-results button")&&(27===o&&angular.element(".autocomplete-results").is(":visible")&&(P.autocompleteResults=[],t.$apply()),e.preventDefault(),13!==o&&32!==o||n.trigger("click"),40===o&&n.parent().next().find("button").focus(),38===o&&n.parent().prev().find("button").focus())}function C(e){P.animalTypeData=e.data}function b(e){P.animalBreedData=e}function S(e){P.categoryData=e.data,j&&p(j),D(e.data)}function D(e){u.getSynonyms().then(function(t){P.synonyms=t,e.forEach(A)})}function A(e){var t=[];e.types.forEach(function(o){var n=w(P.synonyms,e,o);t.push(n)}),P.helpFormattedData=t,T(t)}function T(e){function t(){P.helpQuery=""}function o(e,t){$("#smart-search").typeahead("val",P.helpQuery)}function n(e,o,n){var a=s.getAnimalType(P.helpQuery);p(o.item.subcategory.id,a),t()}var a=[{name:"subcategory.name",weight:.3},{name:"subcategory.tags",weight:.7}];if(!P.smartSearcher){var r={shouldSort:!0,includeScore:!0,threshold:.6,distance:100,keys:a};P.smartSearcher=new c(e,r),P.typeAhead=$("#smart-search").typeahead({highlight:!0});$("#smart-search").typeahead({highlight:!0},{source:function(e,t){t(P.smartSearcher.search(e))},templates:{suggestion:function(e){return e=e.item,'<div><p class="text-muted" data-category="'+e.category.id+'" data-id="'+e.subcategory.id+'">'+e.subcategory.name+"</p></div>"},empty:function(){return'<p class="text-muted">No results found.</p>'}}}).on("typeahead:cursorchange",o).on("typeahead:selected",n)}}function w(e,t,o){var n=L(e,o.name);return n=o.tags?o.tags.concat(n):n,{category:{id:t.id,name:t.name},subcategory:{id:o.id,name:o.name,tags:n}}}function L(e,t){var o=[];return Object.keys(e).forEach(function(n,a){if(t.toLowerCase().indexOf(n)>-1){var r=e[n];o=o.concat(r)}}),o}function k(e){P.animalColorData=e.data}function I(){angular.element("#map").closest("cs-form-control").addClass("error"),t.citySourcedReporterForm.address.$setDirty(),P.address="",t.$apply()}function R(e){console.log(e)}function O(e){var o=angular.element("#map").closest("cs-form-control"),n=t.citySourcedReporterForm.address;P.autocompleteResults=[],P.latitude=e.latLng.lat(),P.longitude=e.latLng.lng(),r.reverseGeocode(P.latitude,P.longitude,function(e){o.removeClass("error"),r.createMarker(E,P.latitude,P.longitude),P.address=e.address.Street.toLowerCase()+", "+e.address.City.toLowerCase()+", "+e.address.State.toUpperCase(),t.$apply()},function(e){o.addClass("error"),n.$setDirty(),P.address="",t.$apply()})}function x(e){P.petTypeData=e.data}function B(e){13===(e.which||e.keyCode)&&e.preventDefault()}var E,P=this,j=a&&a.categoryId?1*a.categoryid:null;P.showCategoryAutocomplete="original-form"!==o.hash(),s.getBreeds().then(b).catch(R),e.get("/sebin/u/t/animal-colors.json").then(k,R),e.get("/sebin/a/d/animal-types.json").then(C,R),e.get("/sebin/q/n/categories.json").then(S,R),e.get("/sebin/m/z/pet-types.json").then(x,R),P.isAnimal=!1,P.page=1,P.isDone=!1,P.isSuccess=!1,P.issueId="",P.isLoading=!1,P.latitude=0,P.longitude=0;var N={center:{lat:39.4003288,lng:-76.60652470000002},scrollwheel:!1,zoom:14,mapTypeId:"roadmap",mapTypeControl:!1,streetViewControl:!1};E=r.createMap("map",N),google.maps.event.addListener(E,"click",O),angular.element("#citysourced-reporter-form").on("keyup keypress",B),angular.element("#address").on("keyup",h),angular.element(window).on("keydown",v),P.fileReportClick=function(){if(y()){var e=[{name:"Category",id:P.category,value:f(P.categoryData,P.category)},{name:"SubCategory",id:P.subCategory,value:f(P.subCategories,P.subCategory)},{name:"Description",id:P.descriptionId,value:P.description},{name:"Latitude",value:P.latitude},{name:"Longitude",value:P.longitude},{name:"FirstName",value:P.firstName},{name:"LastName",value:P.lastName},{name:"Email",value:P.email},{name:"DeviceNumber",value:P.deviceNumber}];if(P.locationDescription&&e.push({name:"Description Of Location",id:P.descriptionOfLocationId,value:P.locationDescription}),P.otherDescription&&e.push({name:"Other Description",id:P.otherDescriptionId,value:P.otherDescription}),P.petType&&e.push({name:"Pet Type",id:P.petType.id,value:f(P.petTypeData,P.petType.id)}),P.petSex&&e.push({name:"Sex",id:P.petSex.id,value:f(P.sex,P.petSex.id)}),P.otherPetType&&e.push({name:"Other Pet Type",id:P.otherPetType,value:f(P.animalTypeData,P.otherPetType)}),P.primaryBreed&&e.push({name:"Primary Breed",id:P.primaryBreed,value:f(P.breeds,P.primaryBreed)}),P.primaryColor&&e.push({name:"Primary Color",id:P.primaryColor,value:f(P.animalColorData,P.primaryColor)}),P.animalDescription&&e.push({name:"Description Of Animal",id:1*angular.element("#animalDescription").attr("data-cs-id"),value:P.animalDescription}),P.streetAddress&&e.push({name:"Complainant Address",id:P.streetAddressId,value:P.streetAddress}),P.city&&e.push({name:"Complainant City",id:P.cityId,value:P.city}),P.state){var t=P.state.id?P.state.id:P.state;e.push({name:"Complainant State",id:t,value:f(P.states,t)})}P.zipCode&&e.push({name:"Complainant Zip Code",id:P.zipCodeId,value:P.zipCode}),P.isLoading=!0,P.isDone=!0,i.post(e,function(e){P.isLoading=!1,P.isSuccess=!0,P.issueId=JSON.parse(e).CsResponse.ReportId},function(e){P.isLoading=!1,console.log(e)})}},P.loadSubCategories=function(){if(!P.category)return void(P.subCategories=[]);angular.forEach(P.categoryData,function(e){m(),e.id==P.category&&(P.subCategories=e.types,e.states?(P.states=e.states,P.state=e.states[0]):P.states=[],e.fields&&(P.streetAddressId=e.fields.streetAddress,P.cityId=e.fields.city,P.zipCodeId=e.fields.zipCode),P.isAnimal="pets and animals"===e.name.toLowerCase(),n(function(){e.descriptionOfAnimal&&(P.descriptionOfAnimalId=e.descriptionOfAnimal),e.descriptionOfLocation&&(P.descriptionOfLocationId=e.descriptionOfLocation),e.otherDescription&&(P.otherDescriptionId=e.otherDescription)},0),P.descriptionId=e.description)})},P.nextClick=function(){y()?2===++P.page&&setTimeout(function(){var e=E.getCenter();google.maps.event.trigger(E,"resize"),E.setCenter(e)},500):t.citySourcedReporterForm.$setSubmitted()},P.prevClick=function(){2===--P.page&&setTimeout(function(){var e=E.getCenter();google.maps.event.trigger(E,"resize"),E.setCenter(e)},500)},P.trackBreed=function(){angular.element.each(P.animalBreedData,function(e,t){if(t.id===P.petType.id)return P.breeds=t.breeds?t.breeds:[],P.sex=t.sex,!0})},P.lookupAddress=function(e){P.autocompleteResults=[],P.address=e,g(e)}}e.controller("BaltCoGoReporterCtrl",["$http","$scope","$location","$timeout","$routeParams","mapServiceComposite","reportService","animalService","smartSearch","dataService",o])}(angular.module("baltcogoApp"),baltimoreCounty.utility.querystringer);