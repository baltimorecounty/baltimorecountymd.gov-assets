!function(){"use strict";angular.module("baltcogoApp",["ngRoute"])}(),function(e){function t(e,t,o){function a(e){var o=t.defer(),a=null,r=null,i="number"==typeof e;return n().then(function(t){for(var n=0,s=t.length;n<s;n+=1){r=t[n];var c=e.indexOf(r.animal)>-1,u=e&&i&&r.id===parseInt(e,10);if(c||u){a=r;break}}o.resolve(a)}),o.promise}function n(){return e.get("/sebin/y/a/animal-breeds.json",{cache:!0}).then(r).catch(i)}function r(e){return e.data}function i(e){o.error("Error: ",e)}return{getAnimalType:a,getBreeds:n}}e.factory("animalService",["$http","$q","$log",t])}(angular.module("baltcogoApp")),function(e){function t(e,t,o){function a(){return e.get("/sebin/c/y/synonyms.json",{cache:!0}).then(n).catch(r)}function n(e){return e.data}function r(e){o.error("Error: ",e)}return{getSynonyms:a}}e.factory("dataService",["$http","$q","$log",t])}(angular.module("baltcogoApp")),function(e){"use strict";function t(e){function t(e){return e.replace(", USA","")}var o,a="http://bcgis.baltimorecountymd.gov/arcgis/rest/services/Geocoders/CompositeGeocode_CS/GeocodeServer",n=function(e,t){return new google.maps.places.Autocomplete(document.getElementById(e),t)},r=function(e,t){return new google.maps.Map(document.getElementById(e),t)},i=function(e,t,a){o&&o.setMap(null),o=new google.maps.Marker({position:{lat:t,lng:a},map:e,icon:"/sebin/n/f/icon-marker-my-report.png",draggable:!1,animation:google.maps.Animation.DROP})},s=function(e,t,o,n){require(["esri/tasks/Locator","esri/geometry/Point"],function(r,i){var s=new i(t,e),c={countryCode:"US",outSpatialReference:4269,url:a},u=new r(c);u.locationToAddress(s).then(o,n)})},c=function(e,t){require(["esri/tasks/Locator","esri/geometry/Point"],function(o,n){var r={countryCode:"US",outSpatialReference:4269,url:a},i={location:new n(-76.60652470000002,39.4003288),text:e},s={responseType:"json"};new o(r).suggestLocations(i,s).then(function(e){var o=[];angular.forEach(e,function(e){o.push(e.text.toLowerCase())}),t(o)},function(e){console.log("err",e)})})},u=function(e,t){return e.score<t.score?1:e.score>t.score?-1:0};return{addressLookup:function(e,t,o){require(["esri/tasks/Locator"],function(n){var r={countryCode:"US",outSpatialReference:4269,url:a},i={address:{SingleLine:e},f:"json"},s={responseType:"json"};new n(r).addressToLocations(i,s).then(function(e){e.length?t(e.sort(u)[0]):o("No location was found for this address.")},o)})},createAutoComplete:n,createMap:r,createMarker:i,pan:function(e,t,o){e.panTo({lat:t,lng:o})},removeCountry:t,reverseGeocode:s,suggestAddresses:c}}e.factory("mapServiceComposite",["$http",t])}(angular.module("baltcogoApp")),function(e){"use strict";function t(e){function t(t,o,a){var n={headers:{"Content-Type":"application/json"}};e.post("//testservices.baltimorecountymd.gov/api/baltcogo/createreport",t,n).then(function(e){o(e.data)},function(e){a(e)})}function o(t,o,a){e.get("//testservices.baltimorecountymd.gov/api/citysourced/getreport/"+t).then(function(e){o(e.data)},function(e){a(e)})}function a(t,o,a){var n={headers:{"Content-Type":"application/json"}};e.post("//testservices.baltimorecountymd.gov/api/citysourced/getreportsbylatlng",t,n).then(function(e){o(e.data)},function(e){a(e)})}return{post:t,getById:o,getNearby:a}}e.factory("reportService",["$http",t])}(angular.module("baltcogoApp")),function(e){function t(e,t){return function(e,t){return e.Fuse?e.Fuse:(t.error("Unable to load the smart search, we probably need to do something else. You probably forgot to include the reference to the fuse library"),null)}(e,t)}e.factory("smartSearch",["$window","$log",t])}(angular.module("baltcogoApp")),function(e){"use strict";function t(e,t,o,a,n,r,i,s,c,u){function l(e){a(function(){$("#categories").val(z.category),$("#subCategories").val(z.subCategory),e&&t.$apply(function(){$("#pet-type").find("option[selected]").removeAttr("selected").end(),$("#pet-type option[label*='"+e.animal+"' i]").prop("selected",!0),d(e),z.trackBreed()})},250)}function d(e){z.petType={id:e.id,name:e.animal}}function p(e,t){angular.forEach(z.categoryData,function(o){o.id===e?(z.category=o,z.loadSubCategories(o.id)):o.types&&angular.forEach(o.types,function(a){a.id===e&&(z.category=o,z.loadSubCategories(o.id),z.subCategory=a,l(t))})})}function m(){z.subCategory="",z.petType="",z.otherPetType="",z.petSex="",z.primaryColor="",z.primaryBreed="",z.animalDescription="",z.streetAddress="",z.city="",z.zipCode="",z.descriptionOfAnimalId=0,z.descriptionOfLocationId=0,z.otherDescriptionId=0}function g(e){r.addressLookup(e,function(e){z.latitude=e.location.y,z.longitude=e.location.x,r.pan(P,z.latitude,z.longitude),r.createMarker(P,z.latitude,z.longitude)},function(e){x()})}function f(e,t){for(var o="",a=0,n=e.length;a<n;a+=1){var r=e[a];if(r.id===t){o=r.name;break}}return o}function y(){var e=angular.element("#citysourced-reporter-form .panel:visible [required]"),o=e.length,a=e.filter(".ng-valid").length,n=t.citySourcedReporterForm.$$controls;return angular.forEach(n,function(e){e.$$element.closest(".panel").is(":visible")&&(e.$pristine&&e.$setDirty(),e.$untouched&&e.$setTouched(),e.$$element.is("#address")&&(0!==z.latitude&&0!==z.longitude||e.$setValidity("required",!1)))}),o===a}function h(e){var o=e.which||e.keyCode;if(40===o)return e.preventDefault(),void angular.element(".autocomplete-results button").first().focus();if(13===o){if(z.autocompleteResults.length>0){var a=z.autocompleteResults[0];z.address=a,z.autocompleteResults=[],t.$apply(),g(a)}}else z.address&&z.address.trim().length>3&&r.suggestAddresses(z.address,function(e){z.autocompleteResults=e,t.$apply()})}function v(e){var o=e.which||e.keyCode,a=angular.element(e.target);a.is(".autocomplete-results button")&&(27===o&&angular.element(".autocomplete-results").is(":visible")&&(z.autocompleteResults=[],t.$apply()),e.preventDefault(),13!==o&&32!==o||a.trigger("click"),40===o&&a.parent().next().find("button").focus(),38===o&&a.parent().prev().find("button").focus())}function C(e){z.animalTypeData=e.data}function b(e){z.animalBreedData=e.data}function S(e){z.categoryData=e.data,N&&p(N),D(e.data)}function D(e){u.getSynonyms().then(function(t){z.synonyms=t,e.forEach(A),L()})}function A(e){var t=[];e.types.forEach(function(o){var a=I(z.synonyms,e,o);t.push(a)}),z.helpFormattedData=z.helpFormattedData.concat(t)}function w(e,t){var o=$("#smart-search");o.typeahead("val",e),t&&o.blur()}function T(){w(z.helpQuery)}function k(e,t){t.item&&t.item.category.name.toLowerCase().indexOf("animals")>-1?s.getAnimalType(z.helpQuery).then(function(e){p(t.item.subcategory.id,e)}):(z.petType="",p(t.item.subcategory.id)),a(function(){w(t.item.subcategory.name,!0)},0)}function L(){var e=[{name:"subcategory.name",weight:.3},{name:"subcategory.tags",weight:.7}];if(!z.smartSearcher){var t={shouldSort:!0,includeScore:!0,threshold:.6,distance:100,keys:e};z.smartSearcher=new c(z.helpFormattedData,t),z.typeAhead=$("#smart-search").typeahead({highlight:!0}),$("#smart-search").typeahead({highlight:!0},{source:function(e,t){t(z.smartSearcher.search(e))},templates:{suggestion:function(e){var t=e.item;return'<div><p class="text-muted" data-category="'+t.category.id+'" data-id="'+t.subcategory.id+'">'+t.subcategory.name+"</p></div>"},empty:function(){return'<p class="text-muted">No results found.</p>'}}}).on("typeahead:cursorchange",T).on("typeahead:selected",k)}}function I(e,t,o){var a=O(e,o.name);return a=o.tags?o.tags.concat(a):a,{category:{id:t.id,name:t.name},subcategory:{id:o.id,name:o.name,tags:a}}}function O(e,t){var o=[];return Object.keys(e).forEach(function(a){if(t.toLowerCase().indexOf(a)>-1){var n=e[a];o=o.concat(n)}}),o}function R(e){z.animalColorData=e.data}function x(){angular.element("#map").closest("cs-form-control").addClass("error"),t.citySourcedReporterForm.address.$setDirty(),z.address="",t.$apply()}function B(e){console.log(e)}function E(e){var o=angular.element("#map").closest("cs-form-control"),a=t.citySourcedReporterForm.address;z.autocompleteResults=[],z.latitude=e.latLng.lat(),z.longitude=e.latLng.lng(),r.reverseGeocode(z.latitude,z.longitude,function(e){o.removeClass("error"),r.createMarker(P,z.latitude,z.longitude),z.address=e.address.Street.toLowerCase()+", "+e.address.City.toLowerCase()+", "+e.address.State.toUpperCase(),t.$apply()},function(){o.addClass("error"),a.$setDirty(),z.address="",t.$apply()})}function j(e){z.petTypeData=e.data}function F(e){13===(e.which||e.keyCode)&&e.preventDefault()}var P,z=this,N=n&&n.categoryId?1*n.categoryid:null,q={center:{lat:39.4003288,lng:-76.60652470000002},scrollwheel:!1,zoom:14,mapTypeId:"roadmap",mapTypeControl:!1,streetViewControl:!1};s.getBreeds().then(b).catch(B),e.get("/sebin/u/t/animal-colors.json").then(R,B),e.get("/sebin/a/d/animal-types.json").then(C,B),e.get("/sebin/q/n/categories.json").then(S,B),e.get("/sebin/m/z/pet-types.json").then(j,B),z.helpFormattedData=[],z.showCategoryAutocomplete="original-form"!==o.hash(),z.isAnimal=!1,z.page=1,z.isDone=!1,z.isSuccess=!1,z.issueId="",z.isLoading=!1,z.latitude=0,z.longitude=0,z.category=0,P=r.createMap("map",q),google.maps.event.addListener(P,"click",E),angular.element("#citysourced-reporter-form").on("keyup keypress",F),angular.element("#address").on("keyup",h),angular.element(window).on("keydown",v),z.toggleForm=function(e){e.preventDefault(),z.showCategoryAutocomplete=!z.showCategoryAutocomplete},z.fileReportClick=function(){if(y()){var e=[{name:"Category",id:z.category,value:f(z.categoryData,z.category)},{name:"SubCategory",id:z.subCategory,value:f(z.subCategories,z.subCategory)},{name:"Description",id:z.descriptionId,value:z.description},{name:"Latitude",value:z.latitude},{name:"Longitude",value:z.longitude},{name:"FirstName",value:z.firstName},{name:"LastName",value:z.lastName},{name:"Email",value:z.email},{name:"DeviceNumber",value:z.deviceNumber}];if(z.locationDescription&&e.push({name:"Description Of Location",id:z.descriptionOfLocationId,value:z.locationDescription}),z.otherDescription&&e.push({name:"Other Description",id:z.otherDescriptionId,value:z.otherDescription}),z.petType&&e.push({name:"Pet Type",id:z.petType.id,value:f(z.petTypeData,z.petType.id)}),z.petSex&&e.push({name:"Sex",id:z.petSex.id,value:f(z.sex,z.petSex.id)}),z.otherPetType&&e.push({name:"Other Pet Type",id:z.otherPetType,value:f(z.animalTypeData,z.otherPetType)}),z.primaryBreed&&e.push({name:"Primary Breed",id:z.primaryBreed,value:f(z.breeds,z.primaryBreed)}),z.primaryColor&&e.push({name:"Primary Color",id:z.primaryColor,value:f(z.animalColorData,z.primaryColor)}),z.animalDescription&&e.push({name:"Description Of Animal",id:1*angular.element("#animalDescription").attr("data-cs-id"),value:z.animalDescription}),z.streetAddress&&e.push({name:"Complainant Address",id:z.streetAddressId,value:z.streetAddress}),z.city&&e.push({name:"Complainant City",id:z.cityId,value:z.city}),z.state){var t=z.state.id?z.state.id:z.state;e.push({name:"Complainant State",id:t,value:f(z.states,t)})}z.zipCode&&e.push({name:"Complainant Zip Code",id:z.zipCodeId,value:z.zipCode}),z.isLoading=!0,z.isDone=!0,i.post(e,function(e){z.isLoading=!1,z.isSuccess=!0,z.issueId=JSON.parse(e).CsResponse.ReportId},function(e){z.isLoading=!1,console.log(e)})}},z.loadSubCategories=function(){if(!z.category)return void(z.subCategories=[]);angular.forEach(z.categoryData,function(e){m(),e.id===z.category.id&&(z.subCategories=e.types,e.id===z.category&&(z.subCategories=e.types,e.states?(z.states=e.states,z.state=e.states[0]):z.states=[],e.fields&&(z.streetAddressId=e.fields.streetAddress,z.cityId=e.fields.city,z.zipCodeId=e.fields.zipCode),z.isAnimal="pets and animals"===e.name.toLowerCase(),a(function(){e.descriptionOfAnimal&&(z.descriptionOfAnimalId=e.descriptionOfAnimal,s.getAnimalType(e.descriptionOfAnimal).then(function(e){d(e)})),e.descriptionOfLocation&&(z.descriptionOfLocationId=e.descriptionOfLocation),e.otherDescription&&(z.otherDescriptionId=e.otherDescription)},0),z.descriptionId=e.description))})},z.nextClick=function(){y()?(z.page+=1,2===z.page&&setTimeout(function(){var e=P.getCenter();google.maps.event.trigger(P,"resize"),P.setCenter(e)},500)):t.citySourcedReporterForm.$setSubmitted()},z.prevClick=function(){z.page-=1,2===z.page&&setTimeout(function(){var e=P.getCenter();google.maps.event.trigger(P,"resize"),P.setCenter(e)},500)},z.trackBreed=function(){for(var e=0,t=z.animalBreedData.length;e<t;e+=1){var o=z.animalBreedData[e];if(o.id===z.petType.id){z.breeds=o.breeds?o.breeds:[],z.sex=o.sex;break}}},z.lookupAddress=function(e){z.autocompleteResults=[],z.address=e,g(e)}}e.controller("BaltCoGoReporterCtrl",["$http","$scope","$location","$timeout","$routeParams","mapServiceComposite","reportService","animalService","smartSearch","dataService",t])}(angular.module("baltcogoApp"));