!function(){"use strict";angular.module("baltcogoApp",[])}(),function(e){"use strict";function t(e){function t(e){return e.replace(", USA","")}var o,r="http://bcgis.baltimorecountymd.gov/arcgis/rest/services/Geocoders/AddressPoint_NAD83/GeocodeServer",n=function(e,t){return new google.maps.places.Autocomplete(document.getElementById(e),t)},a=function(e,t){return new google.maps.Map(document.getElementById(e),t)},i=function(e,t,r){o&&o.setMap(null),o=new google.maps.Marker({position:{lat:t,lng:r},map:e,icon:"/sebin/n/f/icon-marker-my-report.png",draggable:!1,animation:google.maps.Animation.DROP})},s=function(e,t,o,n){require(["esri/tasks/Locator","esri/geometry/Point"],function(a,i){var s=new i(t,e),c={countryCode:"US",outSpatialReference:4269,url:r},u=new a(c);u.locationToAddress(s).then(o,n)})},c=function(e,t){require(["esri/tasks/Locator","esri/geometry/Point"],function(o,n){var a={countryCode:"US",outSpatialReference:4269,url:r},i={location:new n(-76.60652470000002,39.4003288),text:e},s={responseType:"json"};new o(a).suggestLocations(i,s).then(function(e){var o=[];angular.forEach(e,function(e){o.push(e.text.toLowerCase())}),t(o)},function(e){console.log("err",e)})})},u=function(e,t){return e.score<t.score?1:e.score>t.score?-1:0};return{addressLookup:function(e,t,o){require(["esri/tasks/Locator"],function(n){var a={countryCode:"US",outSpatialReference:4269,url:r},i={address:{"Single Line Input":e},f:"json"},s={responseType:"json"};new n(a).addressToLocations(i,s).then(function(e){if(e.length){var r=e.sort(u);t(r[0])}else o("No location was found for this address.")},o)})},createAutoComplete:n,createMap:a,createMarker:i,pan:function(e,t,o){e.panTo({lat:t,lng:o})},removeCountry:t,reverseGeocode:s,suggestAddresses:c}}e.factory("mapServiceComposite",["$http",t])}(angular.module("baltcogoApp")),function(e){"use strict";function t(e){var t,o,r="http://bcgis.baltimorecountymd.gov/arcgis/rest/services/Geocoders/AddressPoint_NAD83/GeocodeServer",n=function(e,r){require(["esri/Map","esri/views/MapView","esri/symbols/PictureMarkerSymbol","esri/Graphic","esri/geometry/Point","dojo/domReady!"],function(n,a,i,s,c){t=new i({url:"http://dev.baltimorecountymd.gov/sebin/n/f/icon-marker-my-report.png",height:60,width:35}),o=new i({url:"http://dev.baltimorecountymd.gov/sebin/n/p/icon-marker-other.png",height:55,width:35});var u={basemap:"topo-vector"},d=new n(u),l={container:e,map:d,zoom:13,center:[-76.6063945,39.4001857]},p=new a(l);r(p,c,s)})},a=function(e,t){require(["esri/tasks/Locator","esri/geometry/Point"],function(o,n){var a={countryCode:"US",outSpatialReference:4269,url:r},i={location:new n(-76.6063945,39.4001857),text:e},s={responseType:"json"};new o(a).suggestLocations(i,s).then(function(e){var o=[];angular.forEach(e,function(e){o.push(e.text)}),t(o)},function(e){console.log("err",e)})})},i=function(e,t){require(["esri/tasks/Locator"],function(o){var n={countryCode:"US",outSpatialReference:4269,url:r},a={address:{"Single Line Input":e},f:"json"},i={responseType:"json"};new o(n).addressToLocations(a,i).then(function(e){if(e.length){var o=e.sort(c);t(o[0])}},function(e){console.log("err",e)})})},s=function(e,t,o,n){require(["esri/tasks/Locator","esri/geometry/Point"],function(a,i){var s=new i(e,t),c={countryCode:"US",outSpatialReference:4269,url:r},u=new a(c);u.locationToAddress(s).then(o,n)})},c=function(e,t){return e.score<t.score?1:e.score>t.score?-1:0};return{createMap:n,dropMarker:function(e,r,n,a,i){require(["esri/Graphic","esri/geometry/Point","dojo/domReady!"],function(s,c){var u=new c(r,n),d=new s(u,i?o:t);e.goTo(u,{animate:!0,duration:250}),a&&e.graphics.removeAll(),e.graphics.add(d)})},lookupAddress:i,reverseGeocode:s,suggestAddresses:a}}e.factory("mapService",["$http",t])}(angular.module("baltcogoApp")),function(e){"use strict";function t(e){function t(t,o,r){var n={headers:{"Content-Type":"application/json"}};e.post("//testservices.baltimorecountymd.gov/api/baltcogo/createreport",t,n).then(function(e){o(e.data)},function(e){r(e)})}function o(t,o,r){e.get("//testservices.baltimorecountymd.gov/api/citysourced/getreport/"+t).then(function(e){o(e.data)},function(e){r(e)})}function r(t,o,r){var n={headers:{"Content-Type":"application/json"}};e.post("//testservices.baltimorecountymd.gov/api/citysourced/getreportsbylatlng",t,n).then(function(e){o(e.data)},function(e){r(e)})}return{post:t,getById:o,getNearby:r}}e.factory("reportService",["$http",t])}(angular.module("baltcogoApp")),function(e,t){"use strict";function o(e,o,r,n,a){function i(e){angular.forEach(w.categoryData,function(t){t.id===e?(w.category=t,w.loadSubCategories(t.id)):t.types&&angular.forEach(t.types,function(o){o.id===e&&(w.category=t,w.loadSubCategories(t.id),w.subCategory=o)})})}function s(){w.subCategory="",w.petType="",w.otherPetType="",w.petSex="",w.primaryColor="",w.primaryBreed="",w.animalDescription="",w.streetAddress="",w.city="",w.zipCode="",w.descriptionOfAnimalId=0,w.descriptionOfLocationId=0,w.otherDescriptionId=0}function c(e){n.addressLookup(e,function(e){w.latitude=e.location.y,w.longitude=e.location.x,n.pan(D,w.latitude,w.longitude),n.createMarker(D,w.latitude,w.longitude)},function(e){v()})}function u(e,t){var o="";return angular.forEach(e,function(e){if(e.id===t)return o=e.name,!0}),o}function d(){var e=angular.element("#citysourced-reporter-form .panel:visible [required]"),t=e.length,r=e.filter(".ng-valid").length,n=o.citySourcedReporterForm.$$controls;return angular.forEach(n,function(e,t,o){e.$$element.closest(".panel").is(":visible")&&(e.$pristine&&e.$setDirty(),e.$untouched&&e.$setTouched(),e.$$element.is("#address")&&(0!==w.latitude&&0!==w.longitude||e.$setValidity("required",!1)))}),t===r}function l(e){var t=e.which||e.keyCode;if(40===t)return e.preventDefault(),void angular.element(".autocomplete-results button").first().focus();if(13===t){if(w.autocompleteResults.length>0){var r=w.autocompleteResults[0];w.address=r,w.autocompleteResults=[],o.$apply(),c(r)}}else w.address&&w.address.trim().length>3&&n.suggestAddresses(w.address,function(e){w.autocompleteResults=e,o.$apply()})}function p(e){var t=e.which||e.keyCode,r=angular.element(e.target);r.is(".autocomplete-results button")&&(27===t&&angular.element(".autocomplete-results").is(":visible")&&(w.autocompleteResults=[],o.$apply()),e.preventDefault(),13!==t&&32!==t||r.trigger("click"),40===t&&r.parent().next().find("button").focus(),38===t&&r.parent().prev().find("button").focus())}function m(e){w.animalTypeData=e.data}function g(e){w.animalBreedData=e.data}function f(e){w.categoryData=e.data,A&&i(A)}function y(e){w.animalColorData=e.data}function v(){angular.element("#map").closest("cs-form-control").addClass("error"),o.citySourcedReporterForm.address.$setDirty(),w.address="",o.$apply()}function h(e){console.log(e)}function C(e){var t=angular.element("#map").closest("cs-form-control"),r=o.citySourcedReporterForm.address;w.autocompleteResults=[],w.latitude=e.latLng.lat(),w.longitude=e.latLng.lng(),n.reverseGeocode(w.latitude,w.longitude,function(e){t.removeClass("error"),n.createMarker(D,w.latitude,w.longitude),w.address=e.address.Street.toLowerCase()+", "+e.address.City.toLowerCase()+", "+e.address.State.toUpperCase(),o.$apply()},function(e){t.addClass("error"),r.$setDirty(),w.address="",o.$apply()})}function b(e){w.petTypeData=e.data}function S(e){13===(e.which||e.keyCode)&&e.preventDefault()}var D,w=this,A=1*t.getAsDictionary().categoryid;e.get("/sebin/y/z/animal-breeds.json").then(g,h),e.get("/sebin/u/t/animal-colors.json").then(y,h),e.get("/sebin/a/d/animal-types.json").then(m,h),e.get("/sebin/q/n/categories.json").then(f,h),e.get("/sebin/m/z/pet-types.json").then(b,h),w.isAnimal=!1,w.page=1,w.isDone=!1,w.isSuccess=!1,w.issueId="",w.isLoading=!1,w.latitude=0,w.longitude=0;var L={center:{lat:39.4003288,lng:-76.60652470000002},scrollwheel:!1,zoom:14,mapTypeId:"roadmap",mapTypeControl:!1,streetViewControl:!1};D=n.createMap("map",L),google.maps.event.addListener(D,"click",C),angular.element("#citysourced-reporter-form").on("keyup keypress",S),angular.element("#address").on("keyup",l),angular.element(window).on("keydown",p),w.fileReportClick=function(){if(d()){var e=[{name:"Category",id:w.category,value:u(w.categoryData,w.category)},{name:"SubCategory",id:w.subCategory,value:u(w.subCategories,w.subCategory)},{name:"Description",id:w.descriptionId,value:w.description},{name:"Latitude",value:w.latitude},{name:"Longitude",value:w.longitude},{name:"FirstName",value:w.firstName},{name:"LastName",value:w.lastName},{name:"Email",value:w.email},{name:"DeviceNumber",value:w.deviceNumber}];if(w.locationDescription&&e.push({name:"Description Of Location",id:w.descriptionOfLocationId,value:w.locationDescription}),w.otherDescription&&e.push({name:"Other Description",id:w.otherDescriptionId,value:w.otherDescription}),w.petType&&e.push({name:"Pet Type",id:w.petType.id,value:u(w.petTypeData,w.petType.id)}),w.petSex&&e.push({name:"Sex",id:w.petSex.id,value:u(w.sex,w.petSex.id)}),w.otherPetType&&e.push({name:"Other Pet Type",id:w.otherPetType,value:u(w.animalTypeData,w.otherPetType)}),w.primaryBreed&&e.push({name:"Primary Breed",id:w.primaryBreed,value:u(w.breeds,w.primaryBreed)}),w.primaryColor&&e.push({name:"Primary Color",id:w.primaryColor,value:u(w.animalColorData,w.primaryColor)}),w.animalDescription&&e.push({name:"Description Of Animal",id:1*angular.element("#animalDescription").attr("data-cs-id"),value:w.animalDescription}),w.streetAddress&&e.push({name:"Complainant Address",id:w.streetAddressId,value:w.streetAddress}),w.city&&e.push({name:"Complainant City",id:w.cityId,value:w.city}),w.state){var t=w.state.id?w.state.id:w.state;e.push({name:"Complainant State",id:t,value:u(w.states,t)})}w.zipCode&&e.push({name:"Complainant Zip Code",id:w.zipCodeId,value:w.zipCode}),w.isLoading=!0,w.isDone=!0,a.post(e,function(e){w.isLoading=!1,w.isSuccess=!0,w.issueId=JSON.parse(e).CsResponse.ReportId},function(e){w.isLoading=!1,console.log(e)})}},w.loadSubCategories=function(){if(!w.category)return void(w.subCategories=[]);angular.forEach(w.categoryData,function(e){s(),e.id==w.category&&(w.subCategories=e.types,e.states?(w.states=e.states,w.state=e.states[0]):w.states=[],e.fields&&(w.streetAddressId=e.fields.streetAddress,w.cityId=e.fields.city,w.zipCodeId=e.fields.zipCode),w.isAnimal="pets and animals"===e.name.toLowerCase(),r(function(){e.descriptionOfAnimal&&(w.descriptionOfAnimalId=e.descriptionOfAnimal),e.descriptionOfLocation&&(w.descriptionOfLocationId=e.descriptionOfLocation),e.otherDescription&&(w.otherDescriptionId=e.otherDescription)},0),w.descriptionId=e.description)})},w.nextClick=function(){d()?2===++w.page&&setTimeout(function(){var e=D.getCenter();google.maps.event.trigger(D,"resize"),D.setCenter(e)},500):o.citySourcedReporterForm.$setSubmitted()},w.prevClick=function(){2===--w.page&&setTimeout(function(){var e=D.getCenter();google.maps.event.trigger(D,"resize"),D.setCenter(e)},500)},w.trackBreed=function(){angular.element.each(w.animalBreedData,function(e,t){if(t.id===w.petType.id)return w.breeds=t.breeds?t.breeds:[],w.sex=t.sex,!0})},w.lookupAddress=function(e){w.autocompleteResults=[],w.address=e,c(e)}}e.controller("BaltCoGoReporterCtrl",["$http","$scope","$timeout","mapServiceComposite","reportService",o])}(angular.module("baltcogoApp"),baltimoreCounty.utility.querystringer);