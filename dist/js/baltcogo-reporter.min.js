!function(){"use strict";angular.module("baltcogoApp",[])}(),function(e){"use strict";function t(){return{urls:{geocodeServer:"http://bcgis.baltimorecountymd.gov/arcgis/rest/services/Geocoders/CompositeGeocode_CS/GeocodeServer",suggestions:"//testservices.baltimorecountymd.gov/api/gis/addressLookup/",createReport:"//testservices.baltimorecountymd.gov/api/baltcogo/createreport",getReport:"//testservices.baltimorecountymd.gov/api/citysourced/getreport/",getReportLatLng:"//testservices.baltimorecountymd.gov/api/citysourced/getreportsbylatlng"}}}e.factory("CONSTANTS",t)}(angular.module("baltcogoApp")),function(e){function t(e,t){function o(e){return e.replace(", USA","")}var a,r=t.urls.geocodeServer,n=function(e,t){return new google.maps.Map(document.getElementById(e),t)},i=function(e,t,o){a&&a.setMap(null),a=new google.maps.Marker({position:{lat:t,lng:o},map:e,icon:"/sebin/n/f/icon-marker-my-report.png",draggable:!1,animation:google.maps.Animation.DROP})},s=function(e,t,o,a){require(["esri/tasks/Locator","esri/geometry/Point"],function(n,i){var s=new i(t,e);new n({countryCode:"US",outSpatialReference:4269,url:r}).locationToAddress(s).then(o,a)})},u=function(o,a){var r=encodeURIComponent(o);e.get(t.urls.suggestions+r).then(function(e){var t=[];angular.forEach(e.data,function(e){t.push({address:e.StreetAddress+", "+e.City+", "+e.Zip,longitude:e.Longitude,latitude:e.Latitude})}),a(t)},function(e){console.log(e)})};return{createMap:n,createMarker:i,pan:function(e,t,o){e.panTo({lat:t,lng:o})},removeCountry:o,reverseGeocode:s,suggestAddresses:u}}e.factory("mapServiceComposite",["$http","CONSTANTS",t])}(angular.module("baltcogoApp")),function(e){"use strict";function t(e,t){function o(o,a,r){var n={headers:{"Content-Type":"application/json"}};e.post(t.urls.createReport,o,n).then(function(e){a(e.data)},function(e){r(e)})}function a(o,a,r){e.get(t.urls.getReport+o).then(function(e){a(e.data)},function(e){r(e)})}function r(o,a,r){var n={headers:{"Content-Type":"application/json"}};e.post(t.urls.getReportLatLng,o,n).then(function(e){a(e.data)},function(e){r(e)})}return{post:o,getById:a,getNearby:r}}e.factory("reportService",["$http","CONSTANTS",t])}(angular.module("baltcogoApp")),function(e,t){"use strict";function o(e,o,a,r,n){function i(e){angular.forEach(S.categoryData,function(t){t.id===e?(S.category=t,S.loadSubCategories()):t.types&&angular.forEach(t.types,function(o){o.id===e&&(S.category=t,S.loadSubCategories(),S.subCategory=o)})})}function s(){S.subCategory="",S.petType="",S.otherPetType="",S.petSex="",S.primaryColor="",S.primaryBreed="",S.animalDescription="",S.streetAddress="",S.city="",S.zipCode="",S.descriptionOfAnimalId=0,S.descriptionOfLocationId=0,S.otherDescriptionId=0}function u(e,t){var o="";return angular.forEach(e,function(e){return e.id===t&&(o=e.name,!0)}),o}function c(){var e=D.getCenter();google.maps.event.trigger(D,"resize"),D.setCenter(e)}function l(){var e=angular.element("#citysourced-reporter-form .panel:visible [required]"),t=e.length,a=e.filter(".ng-valid").length,r=o.citySourcedReporterForm.$$controls;return angular.forEach(r,function(e){e.$$element.closest(".panel").is(":visible")&&(e.$pristine&&e.$setDirty(),e.$untouched&&e.$setTouched(),e.$$element.is("#address")&&(0!==S.latitude&&0!==S.longitude||e.$setValidity("required",!1)))}),t===a}function d(e){var t=e.which||e.keyCode;if(40===t)return e.preventDefault(),void angular.element(".autocomplete-results button").first().focus();if(13!==t)S.address&&S.address.trim().length>3?r.suggestAddresses(S.address,function(e){S.autocompleteResults=e}):S.autocompleteResults=[];else if(S.autocompleteResults.length>0){var a=angular.element(".autocomplete-results button").first();a.trigger("click"),o.$apply()}}function p(e){var t=e.which||e.keyCode,a=angular.element(e.target);a.is(".autocomplete-results button")&&(27===t&&angular.element(".autocomplete-results").is(":visible")&&(S.autocompleteResults=[],o.$apply()),e.preventDefault(),13!==t&&32!==t||a.trigger("click"),40===t&&a.parent().next().find("button").focus(),38===t&&a.parent().prev().find("button").focus())}function m(e){S.animalTypeData=e.data}function g(e){S.animalBreedData=e.data}function f(e){S.categoryData=e.data,T&&i(T)}function y(e){S.animalColorData=e.data}function v(e){console.log(e)}function C(e){var t=angular.element("#map").closest("cs-form-control"),a=o.citySourcedReporterForm.address;S.autocompleteResults=[],S.latitude=e.latLng.lat(),S.longitude=e.latLng.lng(),r.reverseGeocode(S.latitude,S.longitude,function(e){t.removeClass("error"),r.createMarker(D,S.latitude,S.longitude),S.address=e.address.Street.toLowerCase()+", "+e.address.City.toLowerCase()+", "+e.address.State.toUpperCase(),o.$apply()},function(){t.addClass("error"),a.$setDirty(),S.address="",o.$apply()})}function h(e){S.petTypeData=e.data}function b(e){13===(e.which||e.keyCode)&&e.preventDefault()}var D,S=this,T=1*t.getAsDictionary().categoryid;S.isAnimal=!1,S.page=1,S.isDone=!1,S.isSuccess=!1,S.issueId="",S.isLoading=!1,S.latitude=0,S.longitude=0,S.category=0;var A={center:{lat:39.4003288,lng:-76.60652470000002},scrollwheel:!1,zoom:14,mapTypeId:"roadmap",mapTypeControl:!1,streetViewControl:!1};D=r.createMap("map",A),e.get("/sebin/y/a/animal-breeds.json").then(g,v),e.get("/sebin/u/u/animal-colors.json").then(y,v),e.get("/sebin/a/e/animal-types.json").then(m,v),e.get("/sebin/q/m/categories.json").then(f,v),e.get("/sebin/m/a/pet-types.json").then(h,v),google.maps.event.addListener(D,"click",C),angular.element(document).on("keyup keypress","#citysourced-reporter-form",b),angular.element(document).on("keyup","#address",d),angular.element(window).on("keydown",p),S.fileReportClick=function(){if(l()){var e=[{name:"Category",id:S.category.id,value:S.category.name},{name:"SubCategory",id:S.subCategory.id,value:S.subCategory.name},{name:"Description",id:S.descriptionId,value:S.description},{name:"Latitude",value:S.latitude},{name:"Longitude",value:S.longitude},{name:"FirstName",value:S.firstName},{name:"LastName",value:S.lastName},{name:"Email",value:S.email},{name:"DeviceNumber",value:S.deviceNumber}];S.locationDescription&&e.push({name:"Description Of Location",id:S.descriptionOfLocationId,value:S.locationDescription}),S.otherDescription&&e.push({name:"Other Description",id:S.otherDescriptionId,value:S.otherDescription}),S.petType&&e.push({name:"Pet Type",id:S.petType.id,value:u(S.petTypeData,S.petType.id)}),S.petSex&&e.push({name:"Sex",id:S.petSex.id,value:u(S.sex,S.petSex.id)}),S.otherPetType&&e.push({name:"Other Pet Type",id:S.otherPetType,value:u(S.animalTypeData,S.otherPetType)}),S.primaryBreed&&e.push({name:"Primary Breed",id:S.primaryBreed,value:u(S.breeds,S.primaryBreed)}),S.primaryColor&&e.push({name:"Primary Color",id:S.primaryColor,value:u(S.animalColorData,S.primaryColor)}),S.animalDescription&&e.push({name:"Description Of Animal",id:1*angular.element("#animalDescription").attr("data-cs-id"),value:S.animalDescription}),S.streetAddress&&e.push({name:"Complainant Address",id:S.streetAddressId,value:S.streetAddress}),S.city&&e.push({name:"Complainant City",id:S.cityId,value:S.city}),S.zipCode&&e.push({name:"Complainant Zip Code",id:S.zipCodeId,value:S.zipCode}),S.isLoading=!0,S.isDone=!0,n.post(e,function(e){S.isLoading=!1,S.isSuccess=!0,S.issueId=JSON.parse(e).CsResponse.ReportId},function(e){S.isLoading=!1,console.log(e)})}},S.loadSubCategories=function(){if(!S.category)return void(S.subCategories=[]);angular.forEach(S.categoryData,function(e){s(),e.id===S.category.id&&(S.subCategories=e.types,e.states?(S.states=e.states,S.state=e.states[0]):S.states=[],e.fields&&(S.streetAddressId=e.fields.streetAddress,S.cityId=e.fields.city,S.zipCodeId=e.fields.zipCode),S.isAnimal="pets and animals"===e.name.toLowerCase(),a(function(){e.descriptionOfAnimal&&(S.descriptionOfAnimalId=e.descriptionOfAnimal),e.descriptionOfLocation&&(S.descriptionOfLocationId=e.descriptionOfLocation),e.otherDescription&&(S.otherDescriptionId=e.otherDescription)},0),S.descriptionId=e.description)})},S.nextClick=function(){l()?(S.page+=1,2===S.page&&setTimeout(c,500)):o.citySourcedReporterForm.$setSubmitted()},S.prevClick=function(){S.page-=1,2===S.page&&setTimeout(c,500)},S.setLocation=function(e,t,o){S.address=e.autocompleteResult.address,S.longitude=t,S.latitude=o,S.autocompleteResults=[],r.pan(D,o,t),r.createMarker(D,o,t)},S.trackBreed=function(){angular.element.each(S.animalBreedData,function(e,t){return t.id===S.petType.id&&(S.breeds=t.breeds?t.breeds:[],S.sex=t.sex,!0)})}}e.controller("BaltCoGoReporterCtrl",["$http","$scope","$timeout","mapServiceComposite","reportService",o])}(angular.module("baltcogoApp"),baltimoreCounty.utility.querystringer);