!function(){"use strict";angular.module("baltcogoApp",["ngRoute"])}(),function(e){function t(e,t,o){function a(e){var o=t.defer(),a=null,r=null;return n().then(function(t){for(var n=0,i=t.length;n<i;n++)if(r=t[n],e&&e.indexOf(r.animal)>-1){a=r;break}o.resolve(a)}),o.promise}function n(){return e.get("/sebin/u/t/animal-colors.json",{cache:!0}).then(r).catch(i)}function r(e){return e.data}function i(e){o.error("Error: "+e)}return{getAnimalType:a,getBreeds:n}}e.factory("animalService",["$http","$q","$log",t])}(angular.module("baltcogoApp")),function(e){function t(e,t,o){function a(){return e.get("data/synonyms.json",{cache:!0}).then(n).catch(r)}function n(e){return e.data}function r(e){o.error("Error: "+e)}return{getSynonyms:a}}e.factory("dataService",["$http","$q","$log",t])}(angular.module("baltcogoApp")),function(e){"use strict";function t(e){function t(e){return e.replace(", USA","")}var o,a="http://bcgis.baltimorecountymd.gov/arcgis/rest/services/Geocoders/AddressPoint_NAD83/GeocodeServer",n=function(e,t){return new google.maps.places.Autocomplete(document.getElementById(e),t)},r=function(e,t){return new google.maps.Map(document.getElementById(e),t)},i=function(e,t,a){o&&o.setMap(null),o=new google.maps.Marker({position:{lat:t,lng:a},map:e,icon:"/sebin/n/f/icon-marker-my-report.png",draggable:!1,animation:google.maps.Animation.DROP})},s=function(e,t,o,n){require(["esri/tasks/Locator","esri/geometry/Point"],function(r,i){var s=new i(t,e),c={countryCode:"US",outSpatialReference:4269,url:a},u=new r(c);u.locationToAddress(s).then(o,n)})},c=function(e,t){require(["esri/tasks/Locator","esri/geometry/Point"],function(o,n){var r={countryCode:"US",outSpatialReference:4269,url:a},i={location:new n(-76.60652470000002,39.4003288),text:e},s={responseType:"json"};new o(r).suggestLocations(i,s).then(function(e){var o=[];angular.forEach(e,function(e){o.push(e.text.toLowerCase())}),t(o)},function(e){console.log("err",e)})})},u=function(e,t){return e.score<t.score?1:e.score>t.score?-1:0};return{addressLookup:function(e,t,o){require(["esri/tasks/Locator"],function(n){var r={countryCode:"US",outSpatialReference:4269,url:a},i={address:{"Single Line Input":e},f:"json"},s={responseType:"json"};new n(r).addressToLocations(i,s).then(function(e){e.length?t(e.sort(u)[0]):o("No location was found for this address.")},o)})},createAutoComplete:n,createMap:r,createMarker:i,pan:function(e,t,o){e.panTo({lat:t,lng:o})},removeCountry:t,reverseGeocode:s,suggestAddresses:c}}e.factory("mapServiceComposite",["$http",t])}(angular.module("baltcogoApp")),function(e){"use strict";function t(e){function t(t,o,a){var n={headers:{"Content-Type":"application/json"}};e.post("//testservices.baltimorecountymd.gov/api/baltcogo/createreport",t,n).then(function(e){o(e.data)},function(e){a(e)})}function o(t,o,a){e.get("//testservices.baltimorecountymd.gov/api/citysourced/getreport/"+t).then(function(e){o(e.data)},function(e){a(e)})}function a(t,o,a){var n={headers:{"Content-Type":"application/json"}};e.post("//testservices.baltimorecountymd.gov/api/citysourced/getreportsbylatlng",t,n).then(function(e){o(e.data)},function(e){a(e)})}return{post:t,getById:o,getNearby:a}}e.factory("reportService",["$http",t])}(angular.module("baltcogoApp")),function(e){function t(e,t){return function(e,t){return e.Fuse?e.Fuse:(t.error("Unable to load the smart search, we probably need to do something else. You probably forgot to include the reference to the fuse library"),null)}(e,t)}e.factory("smartSearch",["$window","$log",t])}(angular.module("baltcogoApp")),function(e,t){"use strict";function o(e,t,o,a,n,r,i,s,c){function u(e){o(function(){$("#categories").val(E.category),$("#subCategories").val(E.subCategory),e&&t.$apply(function(){$("#pet-type").find("option[selected]").removeAttr("selected").end(),$("#pet-type option[label*='"+e.animal+"' i]").prop("selected",!0),l(e)})},250)}function l(e){E.petType={id:e.id,name:e.animal}}function d(e,t){angular.forEach(E.categoryData,function(o){o.id===e?(E.category=o,E.loadSubCategories(o.id)):o.types&&angular.forEach(o.types,function(a){a.id===e&&(E.category=o.id,E.loadSubCategories(),E.category=o.id,E.subCategory=a.id,u(t))})})}function p(){E.subCategory="",E.petType="",E.otherPetType="",E.petSex="",E.primaryColor="",E.primaryBreed="",E.animalDescription="",E.streetAddress="",E.city="",E.zipCode="",E.descriptionOfAnimalId=0,E.descriptionOfLocationId=0,E.otherDescriptionId=0}function m(e){n.addressLookup(e,function(e){E.latitude=e.location.y,E.longitude=e.location.x,n.pan(B,E.latitude,E.longitude),n.createMarker(B,E.latitude,E.longitude)},function(e){k()})}function g(e,t){var o="";return angular.forEach(e,function(e){if(e.id===t)return o=e.name,!0}),o}function f(){var e=angular.element("#citysourced-reporter-form .panel:visible [required]"),o=e.length,a=e.filter(".ng-valid").length,n=t.citySourcedReporterForm.$$controls;return angular.forEach(n,function(e,t,o){e.$$element.closest(".panel").is(":visible")&&(e.$pristine&&e.$setDirty(),e.$untouched&&e.$setTouched(),e.$$element.is("#address")&&(0!==E.latitude&&0!==E.longitude||e.$setValidity("required",!1)))}),o===a}function y(e){var o=e.which||e.keyCode;if(40===o)return e.preventDefault(),void angular.element(".autocomplete-results button").first().focus();if(13===o){if(E.autocompleteResults.length>0){var a=E.autocompleteResults[0];E.address=a,E.autocompleteResults=[],t.$apply(),m(a)}}else E.address&&E.address.trim().length>3&&n.suggestAddresses(E.address,function(e){E.autocompleteResults=e,t.$apply()})}function h(e){var o=e.which||e.keyCode,a=angular.element(e.target);a.is(".autocomplete-results button")&&(27===o&&angular.element(".autocomplete-results").is(":visible")&&(E.autocompleteResults=[],t.$apply()),e.preventDefault(),13!==o&&32!==o||a.trigger("click"),40===o&&a.parent().next().find("button").focus(),38===o&&a.parent().prev().find("button").focus())}function v(e){E.animalTypeData=e.data}function C(e){E.animalBreedData=e.data}function b(e){E.categoryData=e.data,P&&d(P),S(e.data)}function S(e){c.getSynonyms().then(function(t){E.synonyms=t,e.forEach(D)})}function D(e){var t=[];e.types.forEach(function(e){var o=T(E.synonyms,e);t.push(o)}),E.helpFormattedData=t,A(t)}function A(e){function t(){E.helpQuery=""}function o(e,t){$("#smart-search").typeahead("val",E.helpQuery)}function a(e,o,a){var n=getAnimalType(E.helpQuery);d(o.item.subcategory.id,n),t()}var n=[{name:"subcategory.name",weight:.3},{name:"subcategory.tags",weight:.7}];if(!E.smartSearcher){var r={shouldSort:!0,includeScore:!0,threshold:.6,distance:100,keys:n};E.smartSearcher=new smartSearch(e,r),E.typeAhead=$("#smart-search").typeahead({highlight:!0});$("#smart-search").typeahead({highlight:!0},{source:function(e,t){t(E.smartSearcher.search(e))},templates:{suggestion:function(e){return e=e.item,'<div><p class="text-muted" data-category="'+e.category.id+'" data-id="'+e.subcategory.id+'">'+e.subcategory.name+"</p></div>"},empty:function(){return'<p class="text-muted">No results found.</p>'}}}).on("typeahead:cursorchange",o).on("typeahead:selected",a)}}function T(e,t){var o=L(e,t.name);return o=t.tags?t.tags.concat(o):o,{category:{id:item.id,name:item.name},subcategory:{id:t.id,name:t.name,tags:o}}}function L(e,t){var o=[];return Object.keys(e).forEach(function(a,n){if(t.toLowerCase().indexOf(a)>-1){var r=e[a];o=o.concat(r)}}),o}function w(e){E.animalColorData=e.data}function k(){angular.element("#map").closest("cs-form-control").addClass("error"),t.citySourcedReporterForm.address.$setDirty(),E.address="",t.$apply()}function I(e){console.log(e)}function R(e){var o=angular.element("#map").closest("cs-form-control"),a=t.citySourcedReporterForm.address;E.autocompleteResults=[],E.latitude=e.latLng.lat(),E.longitude=e.latLng.lng(),n.reverseGeocode(E.latitude,E.longitude,function(e){o.removeClass("error"),n.createMarker(B,E.latitude,E.longitude),E.address=e.address.Street.toLowerCase()+", "+e.address.City.toLowerCase()+", "+e.address.State.toUpperCase(),t.$apply()},function(e){o.addClass("error"),a.$setDirty(),E.address="",t.$apply()})}function O(e){E.petTypeData=e.data}function x(e){13===(e.which||e.keyCode)&&e.preventDefault()}var B,E=this,P=a&&a.categoryId?1*a.categoryid:null;i.getBreeds().then(C).catch(I),e.get("/sebin/u/t/animal-colors.json").then(w,I),e.get("/sebin/a/d/animal-types.json").then(v,I),e.get("/sebin/q/n/categories.json").then(b,I),e.get("/sebin/m/z/pet-types.json").then(O,I),E.isAnimal=!1,E.page=1,E.isDone=!1,E.isSuccess=!1,E.issueId="",E.isLoading=!1,E.latitude=0,E.longitude=0;var j={center:{lat:39.4003288,lng:-76.60652470000002},scrollwheel:!1,zoom:14,mapTypeId:"roadmap",mapTypeControl:!1,streetViewControl:!1};B=n.createMap("map",j),google.maps.event.addListener(B,"click",R),angular.element("#citysourced-reporter-form").on("keyup keypress",x),angular.element("#address").on("keyup",y),angular.element(window).on("keydown",h),E.fileReportClick=function(){if(f()){var e=[{name:"Category",id:E.category,value:g(E.categoryData,E.category)},{name:"SubCategory",id:E.subCategory,value:g(E.subCategories,E.subCategory)},{name:"Description",id:E.descriptionId,value:E.description},{name:"Latitude",value:E.latitude},{name:"Longitude",value:E.longitude},{name:"FirstName",value:E.firstName},{name:"LastName",value:E.lastName},{name:"Email",value:E.email},{name:"DeviceNumber",value:E.deviceNumber}];if(E.locationDescription&&e.push({name:"Description Of Location",id:E.descriptionOfLocationId,value:E.locationDescription}),E.otherDescription&&e.push({name:"Other Description",id:E.otherDescriptionId,value:E.otherDescription}),E.petType&&e.push({name:"Pet Type",id:E.petType.id,value:g(E.petTypeData,E.petType.id)}),E.petSex&&e.push({name:"Sex",id:E.petSex.id,value:g(E.sex,E.petSex.id)}),E.otherPetType&&e.push({name:"Other Pet Type",id:E.otherPetType,value:g(E.animalTypeData,E.otherPetType)}),E.primaryBreed&&e.push({name:"Primary Breed",id:E.primaryBreed,value:g(E.breeds,E.primaryBreed)}),E.primaryColor&&e.push({name:"Primary Color",id:E.primaryColor,value:g(E.animalColorData,E.primaryColor)}),E.animalDescription&&e.push({name:"Description Of Animal",id:1*angular.element("#animalDescription").attr("data-cs-id"),value:E.animalDescription}),E.streetAddress&&e.push({name:"Complainant Address",id:E.streetAddressId,value:E.streetAddress}),E.city&&e.push({name:"Complainant City",id:E.cityId,value:E.city}),E.state){var t=E.state.id?E.state.id:E.state;e.push({name:"Complainant State",id:t,value:g(E.states,t)})}E.zipCode&&e.push({name:"Complainant Zip Code",id:E.zipCodeId,value:E.zipCode}),E.isLoading=!0,E.isDone=!0,r.post(e,function(e){E.isLoading=!1,E.isSuccess=!0,E.issueId=JSON.parse(e).CsResponse.ReportId},function(e){E.isLoading=!1,console.log(e)})}},E.loadSubCategories=function(){if(!E.category)return void(E.subCategories=[]);angular.forEach(E.categoryData,function(e){p(),e.id==E.category&&(E.subCategories=e.types,e.states?(E.states=e.states,E.state=e.states[0]):E.states=[],e.fields&&(E.streetAddressId=e.fields.streetAddress,E.cityId=e.fields.city,E.zipCodeId=e.fields.zipCode),E.isAnimal="pets and animals"===e.name.toLowerCase(),o(function(){e.descriptionOfAnimal&&(E.descriptionOfAnimalId=e.descriptionOfAnimal),e.descriptionOfLocation&&(E.descriptionOfLocationId=e.descriptionOfLocation),e.otherDescription&&(E.otherDescriptionId=e.otherDescription)},0),E.descriptionId=e.description)})},E.nextClick=function(){f()?2===++E.page&&setTimeout(function(){var e=B.getCenter();google.maps.event.trigger(B,"resize"),B.setCenter(e)},500):t.citySourcedReporterForm.$setSubmitted()},E.prevClick=function(){2===--E.page&&setTimeout(function(){var e=B.getCenter();google.maps.event.trigger(B,"resize"),B.setCenter(e)},500)},E.trackBreed=function(){angular.element.each(E.animalBreedData,function(e,t){if(t.id===E.petType.id)return E.breeds=t.breeds?t.breeds:[],E.sex=t.sex,!0})},E.lookupAddress=function(e){E.autocompleteResults=[],E.address=e,m(e)}}e.controller("BaltCoGoReporterCtrl",["$http","$scope","$timeout","$routeParams","mapServiceComposite","reportService","animalService","smartSearch","dataService",o])}(angular.module("baltcogoApp"),baltimoreCounty.utility.querystringer);