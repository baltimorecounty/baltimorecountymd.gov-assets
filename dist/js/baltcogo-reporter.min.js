!function(){"use strict";angular.module("baltcogoApp",[]).config(["urlsProvider",function(e){var t=[{"animal.breeds":"/mockups/citysourced/animal-breeds.json"},{"animal.colors":"/mockups/citysourced/animal-colors.json"},{"animal.types":"/mockups/citysourced/animal-types.json"},{categories:"/mockups/citysourced/categories.json"},{"pet.types":"/mockups/citysourced/pet-types.json"},{"report.create":"//testservices.baltimorecountymd.gov/api/baltcogo/createreport"},{"report.get":"//testservices.baltimorecountymd.gov/api/citysourced/getreport/"},{"reports.getByLatLng":"//testservices.baltimorecountymd.gov/api/citysourced/getreportsbylatlng"}];e.setUrls(t)}])}(),function(e){"use strict";function t(e){this.endpoints={};for(var t=0;t<e.length;t++){var o=e[t],n=Object.keys(o)[0];this.endpoints[n]=o[n]}}e.provider("urls",function(){var e=null;this.setUrls=function(t){e=t},this.$get=[function(){return new t(e)}]})}(angular.module("baltcogoApp")),function(e){"use strict";function t(e){function t(e){return e.replace(", USA","")}var o,n="http://bcgis.baltimorecountymd.gov/arcgis/rest/services/Geocoders/AddressPoint_NAD83/GeocodeServer",r=function(e,t){return new google.maps.places.Autocomplete(document.getElementById(e),t)},a=function(e,t){return new google.maps.Map(document.getElementById(e),t)},i=function(e,t,n){o&&o.setMap(null),o=new google.maps.Marker({position:{lat:t,lng:n},map:e,icon:"/sebin/n/f/icon-marker-my-report.png",draggable:!1,animation:google.maps.Animation.DROP})},s=function(e,t,o,r){require(["esri/tasks/Locator","esri/geometry/Point"],function(a,i){var s=new i(t,e),c={countryCode:"US",outSpatialReference:4269,url:n},u=new a(c);u.locationToAddress(s).then(o,r)})},c=function(e,t){require(["esri/tasks/Locator","esri/geometry/Point"],function(o,r){var a={countryCode:"US",outSpatialReference:4269,url:n},i={location:new r(-76.60652470000002,39.4003288),text:e},s={responseType:"json"};new o(a).suggestLocations(i,s).then(function(e){var o=[];angular.forEach(e,function(e){o.push(e.text.toLowerCase())}),t(o)},function(e){console.log("err",e)})})},u=function(e,t){return e.score<t.score?1:e.score>t.score?-1:0};return{addressLookup:function(e,t,o){require(["esri/tasks/Locator"],function(r){var a={countryCode:"US",outSpatialReference:4269,url:n},i={address:{"Single Line Input":e},f:"json"},s={responseType:"json"};new r(a).addressToLocations(i,s).then(function(e){e.length?t(e.sort(u)[0]):o("No location was found for this address.")},o)})},createAutoComplete:r,createMap:a,createMarker:i,pan:function(e,t,o){e.panTo({lat:t,lng:o})},removeCountry:t,reverseGeocode:s,suggestAddresses:c}}e.factory("mapServiceComposite",["$http",t])}(angular.module("baltcogoApp")),function(e){"use strict";function t(e,t){function o(o,n,r){var a={headers:{"Content-Type":"application/json"}};e.post(t.endpoints["report.create"],o,a).then(function(e){n(e.data)},function(e){r(e)})}function n(o,n,r){e.get(t.endpoints["report.get"]+o).then(function(e){n(e.data)},function(e){r(e)})}function r(o,n,r){var a={headers:{"Content-Type":"application/json"}};e.post(t.endpoints["reports.getByLatLng"],o,a).then(function(e){n(e.data)},function(e){r(e)})}return{post:o,getById:n,getNearby:r}}e.factory("reportService",["$http","urls",t])}(angular.module("baltcogoApp")),function(e,t){"use strict";function o(e,o,n,r,a,i){function s(e){angular.forEach(k.categoryData,function(t){t.id===e?(k.category=t,k.loadSubCategories(t.id)):t.types&&angular.forEach(t.types,function(o){o.id===e&&(k.category=t,k.loadSubCategories(t.id),k.subCategory=o)})})}function c(){k.subCategory="",k.petType="",k.otherPetType="",k.petSex="",k.primaryColor="",k.primaryBreed="",k.animalDescription="",k.streetAddress="",k.city="",k.zipCode="",k.descriptionOfAnimalId=0,k.descriptionOfLocationId=0,k.otherDescriptionId=0}function u(e){r.addressLookup(e,function(e){k.latitude=e.location.y,k.longitude=e.location.x,r.pan(L,k.latitude,k.longitude),r.createMarker(L,k.latitude,k.longitude)},function(e){h()})}function l(e,t){var o="";return angular.forEach(e,function(e){if(e.id===t)return o=e.name,!0}),o}function d(){var e=angular.element("#citysourced-reporter-form .panel:visible [required]"),t=e.length,n=e.filter(".ng-valid").length,r=o.citySourcedReporterForm.$$controls;return angular.forEach(r,function(e,t,o){e.$$element.closest(".panel").is(":visible")&&(e.$pristine&&e.$setDirty(),e.$untouched&&e.$setTouched(),e.$$element.is("#address")&&(0!==k.latitude&&0!==k.longitude||e.$setValidity("required",!1)))}),t===n}function p(e){var t=e.which||e.keyCode;if(40===t)return e.preventDefault(),void angular.element(".autocomplete-results button").first().focus();if(13===t){if(k.autocompleteResults.length>0){var n=k.autocompleteResults[0];k.address=n,k.autocompleteResults=[],o.$apply(),u(n)}}else k.address&&k.address.trim().length>3&&r.suggestAddresses(k.address,function(e){k.autocompleteResults=e,o.$apply()})}function m(e){var t=e.which||e.keyCode,n=angular.element(e.target);n.is(".autocomplete-results button")&&(27===t&&angular.element(".autocomplete-results").is(":visible")&&(k.autocompleteResults=[],o.$apply()),e.preventDefault(),13!==t&&32!==t||n.trigger("click"),40===t&&n.parent().next().find("button").focus(),38===t&&n.parent().prev().find("button").focus())}function g(e){k.animalTypeData=e.data}function f(e){k.animalBreedData=e.data}function y(e){k.categoryData=e.data,A&&s(A)}function v(e){k.animalColorData=e.data}function h(){angular.element("#map").closest("cs-form-control").addClass("error"),o.citySourcedReporterForm.address.$setDirty(),k.address="",o.$apply()}function C(e){console.log(e)}function b(e){var t=angular.element("#map").closest("cs-form-control"),n=o.citySourcedReporterForm.address;k.autocompleteResults=[],k.latitude=e.latLng.lat(),k.longitude=e.latLng.lng(),r.reverseGeocode(k.latitude,k.longitude,function(e){t.removeClass("error"),r.createMarker(L,k.latitude,k.longitude),k.address=e.address.Street.toLowerCase()+", "+e.address.City.toLowerCase()+", "+e.address.State.toUpperCase(),o.$apply()},function(e){t.addClass("error"),n.$setDirty(),k.address="",o.$apply()})}function D(e){k.petTypeData=e.data}function S(e){13===(e.which||e.keyCode)&&e.preventDefault()}var L,k=this,A=1*t.getAsDictionary().categoryid;e.get(i.endpoints["animal.breeds"]).then(f,C),e.get(i.endpoints["animal.colors"]).then(v,C),e.get(i.endpoints["animal.types"]).then(g,C),e.get(i.endpoints.categories).then(y,C),e.get(i.endpoints["pet.types"]).then(D,C),k.isAnimal=!1,k.page=1,k.isDone=!1,k.isSuccess=!1,k.issueId="",k.isLoading=!1,k.latitude=0,k.longitude=0;var T={center:{lat:39.4003288,lng:-76.60652470000002},scrollwheel:!1,zoom:14,mapTypeId:"roadmap",mapTypeControl:!1,streetViewControl:!1};L=r.createMap("map",T),google.maps.event.addListener(L,"click",b),angular.element("#citysourced-reporter-form").on("keyup keypress",S),angular.element("#address").on("keyup",p),angular.element(window).on("keydown",m),k.fileReportClick=function(){if(d()){var e=[{name:"Category",id:k.category,value:l(k.categoryData,k.category)},{name:"SubCategory",id:k.subCategory,value:l(k.subCategories,k.subCategory)},{name:"Description",id:k.descriptionId,value:k.description},{name:"Latitude",value:k.latitude},{name:"Longitude",value:k.longitude},{name:"FirstName",value:k.firstName},{name:"LastName",value:k.lastName},{name:"Email",value:k.email},{name:"DeviceNumber",value:k.deviceNumber}];if(k.locationDescription&&e.push({name:"Description Of Location",id:k.descriptionOfLocationId,value:k.locationDescription}),k.otherDescription&&e.push({name:"Other Description",id:k.otherDescriptionId,value:k.otherDescription}),k.petType&&e.push({name:"Pet Type",id:k.petType.id,value:l(k.petTypeData,k.petType.id)}),k.petSex&&e.push({name:"Sex",id:k.petSex.id,value:l(k.sex,k.petSex.id)}),k.otherPetType&&e.push({name:"Other Pet Type",id:k.otherPetType,value:l(k.animalTypeData,k.otherPetType)}),k.primaryBreed&&e.push({name:"Primary Breed",id:k.primaryBreed,value:l(k.breeds,k.primaryBreed)}),k.primaryColor&&e.push({name:"Primary Color",id:k.primaryColor,value:l(k.animalColorData,k.primaryColor)}),k.animalDescription&&e.push({name:"Description Of Animal",id:1*angular.element("#animalDescription").attr("data-cs-id"),value:k.animalDescription}),k.streetAddress&&e.push({name:"Complainant Address",id:k.streetAddressId,value:k.streetAddress}),k.city&&e.push({name:"Complainant City",id:k.cityId,value:k.city}),k.state){var t=k.state.id?k.state.id:k.state;e.push({name:"Complainant State",id:t,value:l(k.states,t)})}k.zipCode&&e.push({name:"Complainant Zip Code",id:k.zipCodeId,value:k.zipCode}),k.isLoading=!0,k.isDone=!0,a.post(e,function(e){k.isLoading=!1,k.isSuccess=!0,k.issueId=JSON.parse(e).CsResponse.ReportId},function(e){k.isLoading=!1,console.log(e)})}},k.loadSubCategories=function(){if(!k.category)return void(k.subCategories=[]);angular.forEach(k.categoryData,function(e){c(),e.id==k.category&&(k.subCategories=e.types,e.states?(k.states=e.states,k.state=e.states[0]):k.states=[],e.fields&&(k.streetAddressId=e.fields.streetAddress,k.cityId=e.fields.city,k.zipCodeId=e.fields.zipCode),k.isAnimal="pets and animals"===e.name.toLowerCase(),n(function(){e.descriptionOfAnimal&&(k.descriptionOfAnimalId=e.descriptionOfAnimal),e.descriptionOfLocation&&(k.descriptionOfLocationId=e.descriptionOfLocation),e.otherDescription&&(k.otherDescriptionId=e.otherDescription)},0),k.descriptionId=e.description)})},k.nextClick=function(){d()?2===++k.page&&setTimeout(function(){var e=L.getCenter();google.maps.event.trigger(L,"resize"),L.setCenter(e)},500):o.citySourcedReporterForm.$setSubmitted()},k.prevClick=function(){2===--k.page&&setTimeout(function(){var e=L.getCenter();google.maps.event.trigger(L,"resize"),L.setCenter(e)},500)},k.trackBreed=function(){angular.element.each(k.animalBreedData,function(e,t){if(t.id===k.petType.id)return k.breeds=t.breeds?t.breeds:[],k.sex=t.sex,!0})},k.lookupAddress=function(e){k.autocompleteResults=[],k.address=e,u(e)}}e.controller("BaltCoGoReporterCtrl",["$http","$scope","$timeout","mapServiceComposite","reportService","urls",o])}(angular.module("baltcogoApp"),baltimoreCounty.utility.querystringer);