require(["myPlaceholder","bootstrap","esri/dijit/Legend","underscore","doTimeout","esri/map","esri/SpatialReference","esri/geometry/Extent","esri/tasks/RelationshipQuery","dojo/promise/all","esri/InfoTemplate","jquery","mustache","esri/dijit/editing/AttachmentEditor","esri/geometry/Point","esri/layers/FeatureLayer","esri/tasks/query","esri/TimeExtent","dojo/number","dojo/date/locale","dojo/dom","dojo/on","dojo/_base/array","dojo/store/Memory","dgrid/OnDemandGrid","dojo/domReady!"],function(t,e,a,r,n,i,o,s,l,d,c,u,f,g,p,h,v,m,b,E,P,w,A,I,y){var j,L,C,D,T,k,M,R,N=function(){function t(t){return t&&"string"==typeof t&&(t=t.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),t=t.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,""),e.innerHTML=t,t=e.textContent,e.textContent=""),t}var e=document.createElement("div");return t}(),O={ids:[],parks:[],trails:[],attachs:[]};j=function(t){return"<div id='info' class='park-info'><p>"+t+"</p><a href='https://www.google.com/maps/?daddr=${Lat},${Long}'>Get Directions</a><a href='#parkid${ID}-${OBJECTID}' class='js-infoWindow-more-info pull-right' data-object-id='${OBJECTID}' title='View More Information on ${NAME}'>More Information</a><div id='attach'></div></div>"},L="<ul class='trails'>{{#.}}{{#attributes}}{{#NAME}}",L+="<li id='parkid{{ID}}-{{OBJECTID}}' data-park-id='{{ID}}' data-object-id='{{OBJECTID}}' class='park'>",L+="<div class='row'>",L+="<div class='col-md-8 col-sm-8'>",L+="<h2 class='park-name'>{{NAME}}</h2>",L+="</div>",L+="<div class='col-md-4 col-sm-4 health-coalition'>",L+="{{#isEndorsed}}{{HC_ENDORSEMENT}}{{/isEndorsed}}",L+="</div>",L+="</div>",L+="<div class='row'>",L+="<div class='col-md-8 col-sm-8'>",L+="<strong>About this Site</strong>",L+="<p class='park-desc'>{{#convertLinks}}{{DESC_}}{{/convertLinks}}</p>",L+="<div class='park-map'></div>",L+="</div>",L+="<div class='col-md-4 col-sm-4'>",L+="<address class='park-address'>",L+="<strong>Contact Information</strong><br />",L+="{{CONTACT}}<br>",L+="{{#ADDRESS}}<span class='address-label'>Address:</span> <a href='http://maps.google.com/maps?daddr={{Lat}},{{Long}}' title='Get Directions to {{NAME}}'>{{ADDRESS}}</a>{{/ADDRESS}}",L+="{{^ADDRESS}}<a href='http://maps.google.com/maps?daddr={{LATLNG}}' title='Get Directions to {{NAME}}'>{{LATLNG}}</a>{{/ADDRESS}}<br>",L+="{{#PHONE}}<span class='address-label'>Phone:</span> {{PHONE}}<br />{{/PHONE}}",L+="{{#CONTACT_EMAIL}}<span class='address-label'>Email:</span> <a href='mailto:{{CONTACT_EMAIL}}' title='Email {{CONTACT}}'>{{CONTACT_EMAIL}}</a>{{/CONTACT_EMAIL}}",L+="</address>",L+="</div>",L+="</div>",L+="<div class='row'>",L+="<div class='park-trails col-md-12'>",L+="<ul class='nav nav-tabs park-trails-nav'></ul>",L+="<div class='trail-tabs tab-content'></div>",L+="</div>",L+="</div>",L+="</li>",L+="{{/NAME}}{{/attributes}}{{/.}}</ul>";var S="";S+="{{#.}}",S+="{{#attributes}}",S+="<li><a href='#trail{{PARK_ID}}{{OBJECTID}}' data-toggle='tab'>{{TRAIL_NAME}}</a></li>",S+="{{/attributes}}",S+="{{/.}}",C="",C+="{{#.}}",C+="{{#attributes}}",C+="<div id='trail{{PARK_ID}}{{OBJECTID}}' data-object-id='{{OBJECTID}}' class=\"trail tab-pane\">",C+='<h4 class="trail-name">{{TRAIL_NAME}}</h4>',C+='<p class="trail-desc">{{TRAIL_DESC}}</p>',C+='<p class="trail-type"><strong>Type:</strong> {{TRAIL_TYPE}}</p>',C+='<div class="trail-map"></div>',C+="</div>",C+="{{/attributes}}",C+="{{/.}}",D=function(t){return"{{#.}}<a href='{{url}}' id='attach-{{objectId}}' class='btn btn-default trail-map object-{{objectId}}' title='View the Park Map'>"+t+"</a>{{/.}}"},window.myData=O,u(".initial-message").hide();var _=u(".js-trails-filter");_.val()&&(_.val(""),u("body").focus()),T=new i("map",{basemap:"hybrid",center:[-76.6455,39.4671],zoom:10,displayGraphicsOnPan:!1,autoResize:!1}),T.on("load",function(){T.on("extent-change",ut),k=new h("//gis.baltimorecountymd.gov/arcgis/rest/services/Apps/WalkingTrailsExternalViewer/MapServer/0",{name:"parks",mode:esri.layers.FeatureLayer.MODE_SNAPSHOT,outFields:["*"],infoTemplate:new c("")}),k.on("load",H),k.on("click",q),M=new h("//gis.baltimorecountymd.gov/arcgis/rest/services/Apps/WalkingTrailsExternalViewer/MapServer/1",{name:"trails",mode:esri.layers.FeatureLayer.MODE_SNAPSHOT,outFields:["*"],orderByFields:"NAME ASC"}),T.addLayers([k])}),T.on("layers-add-result",function(t){var e=A.map(t.layers,function(t,e){return{layer:t.layer,title:t.layer.name}});if(e.length>0){new a({map:T,layerInfos:e},"legend").startup()}});var x=function(t){if(R.recordsPerPage!==R.totalRecords){var e=u(this),a=parseInt(e.attr("data-object-id")),r=(e.attr("href"),ot(a));ht(r)}},q=function(t){var e=t.graphic,a=e.geometry,r=B(a);e.attributes.Lat=r.Lat,e.attributes.Long=r.Long,X(t,j)},B=function(t){var e=new p(t.x,t.y,t.spatialReference);return{Lat:e.getLatitude(),Long:e.getLongitude()}},F=function(t){if(t){var e=new v;e.outFields=["*"],e.where="PARK_ID IN ("+t+")";var a=gt("trails",e);a?Z(a.features):M.queryFeatures(e).then(function(t){G("trails",{query:e,data:t}),Z(t.features)})}},H=function(t){var e=new v;e.where="NAME != 'null' ORDER BY NAME","string"==typeof t&&(e.where=t);var a=gt("ids",e);a?nt(a.objectIds):k.queryIds(e,function(t){J({query:e,objectIds:t}),nt(t)})},$=function(t){for(var e=0;e<O.attachs.length;e++){if(r.isEqual(O.attachs[e],t))return}O.attachs.push(t)},J=function(t){for(var e=0;e<O.ids.length;e++){if(r.isEqual(t,O.ids[e]))return}O.ids.push(t)},G=function(t,e){for(var a=0;a<O[t].length;a++){var n=O[t][a];if(r.isEqual(n.query,e.query))return}O[t].push(e)},K=function(t,e){return t.queryAttachmentInfos(e)},V=function(t){var e=u(t.target),a=e.val(),r=et(a);H(r)},W=function(t,e){if(ct(t)){var a=parseInt(t),r=R.currentPage;10===a?r=Math.ceil(r/2):r*=2,R.recordsPerPage=a,ht(r)}else R.recordsPerPage=R.totalRecords,ht(1)},Y=function(t,e,a){if(t.length>0)for(var r=t.length-1;r>=0;r--){var n=f.render(D(a),t[r]),i="."+e+"[data-object-id="+t[r].objectId+"] ."+e+"-map";setTimeout(function(){u(i).html(n).find(".trails-header-hidden").removeClass("trails-header-hidden")},250)}},U=function(t,e,a,r){for(var n=0;n<e.length;n++){var i=e[n],o=ft(t.name,i);o?Y(o,a,r):K(t,e[n]).then(function(e){e.length&&($({layer:t.name,objectId:i,data:e}),Y(e,a,r))})}},z=function(t,e){var a=t.features;a=tt(a.sort(at)),a.convertLinks=function(){return function(t,e){var a=N(e(t));return a||(a=u("<div />").html(e(t)).text()),a.replace(/(http:\/\/[^\s]+)/gi,'<a href="$1" title="View more information">$1</a>')}},a.isEndorsed=function(){return function(t,e){if("NO"!==e(t))return"<a href='/Agencies/health/coalition/lhc.html' title='Learn more about the Baltimore County Health Colation'><img src='/sebin/e/t/coalitionapproved.gif' alt='This walking trail location is Health Coalition approved.' /></a>"}};var r=f.render(L,a);u(".parks").html(r);var n=Q(it(t.features,"ID").join(",")),i=it(t.features,"OBJECTID");F(n),i&&U(k,i,"park","Site Map"),e&&"function"==typeof e&&e(r)},Q=function(t){return r.without(t.split(","),"")},Z=function(t){t.sort(rt),u(".park-trails-nav, .trail-tabs").html("");for(var e=0;e<t.length;e++){var a=f.render(C,t[e]),r="[data-park-id='"+t[e].attributes.PARK_ID+"']",n=f.render(S,t[e]);u(".park-trails-nav",r).append(n).find("li:first").addClass("active").find("a").text("Featured Trail"),u(".trail-tabs",r).append(a).parent().find(".trails-header-hidden").removeClass("trails-header-hidden").end().find(".tab-pane:first").addClass("active")}var i=it(t,"OBJECTID");U(M,i,"trail","Trail Map")},X=function(t,e){k.infoTemplate.setTitle("${NAME}");var a=t.graphic.attributes,r=a.DESC_;r.length>255&&(r=a.DESC_.substring(0,255)+"..."),k.infoTemplate.setContent(e(r)),T.infoWindow.show(t.point,T.getInfoWindowAnchor(t.point))},tt=function(t){for(var e=0;e<t.length;e++){var a=B(t[e].geometry);t[e].attributes.Lat=a.Lat,t[e].attributes.Long=a.Long}return t},et=function(t){return"ZIPCODE LIKE '"+t+"%' OR UPPER(CITY) LIKE UPPER('"+t+"%') or UPPER(NAME) LIKE UPPER('%"+t+"%') AND NAME != 'null' ORDER BY NAME"},at=function(t,e){var a=t.attributes.NAME.toLowerCase(),r=e.attributes.NAME.toLowerCase();return a<r?-1:a>r?1:0},rt=function(t,e){var a=t.attributes.TRAIL_NAME.toLowerCase(),r=e.attributes.TRAIL_NAME.toLowerCase();return a<r?-1:a>r?1:0},nt=function(t){if(t){Et(t);var e=wt();ht(e,window.location.hash)}else u(".parks").html("<h2>No Matching Parks</h2>")},it=function(t,e){for(var a=[],r=0;r<t.length;r++)a.push(t[r].attributes[e]);return a},ot=function(t){var e=st(t);return Math.ceil((e+1)/R.recordsPerPage)},st=function(t){for(var e=0;e<R.objectIds.length;e++)if(R.objectIds[e]===t)return e},lt=function(t,e){u(t).html().length;t=t.replace("#",""),document.getElementById(t).scrollIntoView()},dt=function(){u(".js-loading-message").hide()},ct=function(t){return t-0==t&&(""+t).replace(/^\s+|\s+$/g,"").length>0},ut=function(t){var e=T.getLevel(),a=T.getLayer(M.id);if(e>=15){if(void 0===a)return T.addLayer(M)}else if(a)return T.removeLayer(M)},ft=function(t,e){for(var a=0;a<O.attachs.length;a++)if(r.isEqual(e,O.attachs[a].objectId)&&r.isEqual(t,O.attachs[a].layer))return O.attachs[a].data},gt=function(t,e){for(var a=0;a<O[t].length;a++)if(r.isEqual(e,O[t][a].query))return O[t][a].data},pt=function(t){var e=u(".js-page-btn"),a=u(".page-"+t),r=u(".js-last-btn, .js-next-btn"),n=u(".js-first-btn, .js-prev-btn"),i=u(".js-first-btn, .js-last-btn, .js-prev-btn, .js-next-btn"),o=u(".paging-numbers:first").children().length;e.removeClass("active"),a.addClass("active"),t===R.totalPages()&&1!==R.totalPages()?(r.attr("disabled","disabled"),n.removeAttr("disabled")):1===t?(n.attr("disabled","disabled"),r.removeAttr("disabled"),1===o&&r.attr("disabled","disabled")):i.removeAttr("disabled")},ht=function(t,e,a){if(!(t<1||t>R.totalPages)){mt();var r=R.recordsPerPage*(parseInt(t)-1),n=r+R.recordsPerPage,i=gt("parks",s),o=R.totalPages();if(R.currentPage=t,vt(o,t),bt(r,n,t),i)z(i,a),dt();else{var s=new v;s.objectIds=R.objectIds.slice(r,n),s.where="'NAME'!='null' ORDER BY NAME",s.outFields=["*"],k.queryFeatures(s,function(t){G("parks",{query:s,data:t}),z(t,function(t){dt(),e&&lt(e),a&&"function"==typeof a&&a()})})}}},vt=function(t,e){var a,r,n="";e<=3?(a=0,r=t<5?t:5):e>t-3?(a=t-5,r=t):(a=e-3,r=e+2);for(var i=a;i<r;i++){var o=i+1;n+="<button class='btn btn-default js-page-btn page-"+o+"' id='page-"+o+"'>"+o+"</button>"}u(".paging-numbers").html(n),pt(e)},mt=function(){u(".js-loading-message").show()},bt=function(t,e,a){var r=R.totalPages(),n=t+1+" - "+e+" of "+R.totalRecords;R.currentPage=a,R.currentPage===r&&(n=t+1+" - "+R.totalRecords+" of "+R.totalRecords),u(".page-info").html(" | Page: "+R.currentPage+" of "+r),u(".records-info").html(n)},Et=function(t,e){R={objectIds:t,totalRecords:t.length,totalPages:function(){var e=this;return Math.ceil(t.length/e.recordsPerPage)},currentRange:function(){var t=this;return(1===t.currentPage?1:(t.currentPage-1)*t.recordsPerPage+1)+" to "+(t.recordsPerPage*t.currentPage>t.totalRecords?t.totalRecords:t.recordsPerPage*t.currentPage)},currentPage:e||0,recordsPerPage:5},R.currentPage>R.totalPages()&&ht(R.currentPage-1)};u(document).on("click",".js-prev-btn",function(t){t.preventDefault(),ht(R.currentPage-1),window.location.hash=1===R.currentPage?"page-1":"page-"+R.currentPage}),u(document).on("click",".js-next-btn",function(t){t.preventDefault(),ht(R.currentPage+1),window.location.hash="page-"+R.currentPage}),u(document).on("click",".js-first-btn",function(t){t.preventDefault(),ht(1),window.location.hash="page-1"}),u(document).on("click",".js-last-btn",function(t){t.preventDefault(),ht(R.totalPages()),window.location.hash="page-"+R.totalPages()}),u(document).on("click",".js-infoWindow-more-info",x),u(document).on("click",".js-legend-toggle",function(t){t.preventDefault();var e=u(t.target),a=e.text().toLowerCase(),r=u(".map-legend"),n=u(".map-container");"show legend"===a?(r.addClass("map-legend-visible"),n.addClass("col-md-9 col-sm-9"),e.text("Hide Legend")):(r.removeClass("map-legend-visible"),n.removeClass("col-md-9 col-sm-9"),e.text("Show Legend"))}),u(document).on("click",".js-page-btn",function(t){t.preventDefault();var e=u(t.target),a=parseInt(e.text());window.location.hash=e.attr("id"),ht(a)}),u(document).on("click",".js-show-records",function(t){t.preventDefault();var e=u(t.target),a=e.text();u(".js-show-records button").removeClass("active"),e.addClass("active"),u(".js-show-records").html(e.parent().html());var r=u(".paging").children();"show all"===a.toLowerCase()?r.hide():r.show(),W(a,R.currentPage)}),u(document).on("keyup",".js-trails-filter",function(t){window.location.hash="filter",u(this).doTimeout("typing",250,function(){V(t)}),u(this).focus()}),u(document).on("click",".trail-tabs nav-tabs a",function(t){t.preventDefault(),u(this).tab("show")}),u(document).on("click",".js-clear-filter",function(t){t.preventDefault(),u(this).parent().find("input").val("").trigger("keyup")});var Pt=function(){var t=window.location.hash,e=wt();if(!t)return void ht(1,t);ht(e,t)},wt=function(){var t=window.location.hash,e=1;if(t.indexOf("page")>-1&&(e=parseInt(t.split("-")[1])),t.indexOf("parkid")>-1){var a=parseInt(t.split("-")[1]);e=ot(a)}return e};window.onhashchange=Pt});