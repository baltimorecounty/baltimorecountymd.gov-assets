"use strict";require(["myPlaceholder","bootstrap","esri/dijit/Legend","underscore","doTimeout","esri/map","esri/SpatialReference","esri/geometry/Extent","esri/tasks/RelationshipQuery","dojo/promise/all","esri/InfoTemplate","jquery","mustache","esri/dijit/editing/AttachmentEditor","esri/geometry/Point","esri/layers/FeatureLayer","esri/tasks/query","esri/TimeExtent","dojo/number","dojo/date/locale","dojo/dom","dojo/on","dojo/_base/array","dojo/store/Memory","dgrid/OnDemandGrid","dojo/domReady!"],function(t,e,a,r,n,i,o,s,l,d,c,u,f,g,p,h,v,m,b,P,E,w,y,I,A){var L,j,C,D,T,k,M,N,R=function(){function t(t){return t&&"string"==typeof t&&(t=t.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),t=t.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,""),e.innerHTML=t,t=e.textContent,e.textContent=""),t}var e=document.createElement("div");return t}(),O={parkLayer:"//bcgis.baltimorecountymd.gov/arcgis/rest/services/Apps/WalkingTrails/MapServer/0",trailLayer:"//bcgis.baltimorecountymd.gov/arcgis/rest/services/Apps/WalkingTrails/MapServer/1"},S={ids:[],parks:[],trails:[],attachs:[]};L=function(t){return"<div id='info' class='park-info'><p>"+t+"</p><a href='https://www.google.com/maps/?daddr=${Lat},${Long}'>Get Directions</a><a href='#parkid${ID}-${OBJECTID}' class='js-infoWindow-more-info pull-right' data-object-id='${OBJECTID}' title='View More Information on ${NAME}'>More Information</a><div id='attach'></div></div>"},j="<ul class='trails'>{{#.}}{{#attributes}}{{#NAME}}",j+="<li id='parkid{{ID}}-{{OBJECTID}}' data-park-id='{{ID}}' data-object-id='{{OBJECTID}}' class='park'>",j+="<div class='row'>",j+="<div class='col-md-8 col-sm-8'>",j+="<h2 class='park-name'>{{NAME}}</h2>",j+="</div>",j+="<div class='col-md-4 col-sm-4 health-coalition'>",j+="{{#isEndorsed}}{{HC_ENDORSEMENT}}{{/isEndorsed}}",j+="</div>",j+="</div>",j+="<div class='row'>",j+="<div class='col-md-8 col-sm-8'>",j+="<strong>About this Site</strong>",j+="<p class='park-desc'>{{#convertLinks}}{{DESC_}}{{/convertLinks}}</p>",j+="<div class='park-map'></div>",j+="</div>",j+="<div class='col-md-4 col-sm-4'>",j+="<address class='park-address'>",j+="<strong>Contact Information</strong><br />",j+="{{CONTACT}}<br>",j+="{{#ADDRESS}}<span class='address-label'>Address:</span> <a href='http://maps.google.com/maps?daddr={{Lat}},{{Long}}' title='Get Directions to {{NAME}}'>{{ADDRESS}}</a>{{/ADDRESS}}",j+="{{^ADDRESS}}<a href='http://maps.google.com/maps?daddr={{LATLNG}}' title='Get Directions to {{NAME}}'>{{LATLNG}}</a>{{/ADDRESS}}<br>",j+="{{#PHONE}}<span class='address-label'>Phone:</span> {{PHONE}}<br />{{/PHONE}}",j+="{{#CONTACT_EMAIL}}<span class='address-label'>Email:</span> <a href='mailto:{{CONTACT_EMAIL}}' title='Email {{CONTACT}}'>{{CONTACT_EMAIL}}</a>{{/CONTACT_EMAIL}}",j+="</address>",j+="</div>",j+="</div>",j+="<div class='row'>",j+="<div class='park-trails col-md-12'>",j+="<ul class='nav nav-tabs park-trails-nav'></ul>",j+="<div class='trail-tabs tab-content'></div>",j+="</div>",j+="</div>",j+="</li>",j+="{{/NAME}}{{/attributes}}{{/.}}</ul>";var _="";_+="{{#.}}",_+="{{#attributes}}",_+="<li><a href='#trail{{PARK_ID}}{{OBJECTID}}' data-toggle='tab'>{{TRAIL_NAME}}</a></li>",_+="{{/attributes}}",_+="{{/.}}",C="",C+="{{#.}}",C+="{{#attributes}}",C+="<div id='trail{{PARK_ID}}{{OBJECTID}}' data-object-id='{{OBJECTID}}' class=\"trail tab-pane\">",C+='<h4 class="trail-name">{{TRAIL_NAME}}</h4>',C+='<p class="trail-desc">{{TRAIL_DESC}}</p>',C+='<p class="trail-type"><strong>Type:</strong> {{TRAIL_TYPE}}</p>',C+='<div class="trail-map"></div>',C+="</div>",C+="{{/attributes}}",C+="{{/.}}",D=function(t){return"{{#.}}<a href='{{url}}' id='attach-{{objectId}}' class='btn btn-default trail-map object-{{objectId}}' title='View the Park Map'>"+t+"</a>{{/.}}"},window.myData=S,u(".initial-message").hide();var q=u(".js-trails-filter");q.val()&&(q.val(""),u("body").focus()),T=new i("map",{basemap:"hybrid",center:[-76.6455,39.4671],zoom:10,displayGraphicsOnPan:!1,autoResize:!1}),T.on("load",function(){T.on("extent-change",ft),k=new h(O.parkLayer,{name:"parks",mode:esri.layers.FeatureLayer.MODE_SNAPSHOT,outFields:["*"],orderByFields:["NAME"],infoTemplate:new c("")}),k.on("load",$),k.on("click",B),M=new h(O.trailLayer,{name:"trails",mode:esri.layers.FeatureLayer.MODE_SNAPSHOT,outFields:["*"],orderByFields:["NAME ASC"]}),T.addLayers([k])}),T.on("layers-add-result",function(t){var e=y.map(t.layers,function(t,e){return{layer:t.layer,title:t.layer.name}});if(e.length>0){new a({map:T,layerInfos:e},"legend").startup()}});var x=function(t){if(N.recordsPerPage!==N.totalRecords){var e=u(this),a=parseInt(e.attr("data-object-id")),r=(e.attr("href"),st(a));vt(r)}},B=function(t){var e=t.graphic,a=e.geometry,r=F(a);e.attributes.Lat=r.Lat,e.attributes.Long=r.Long,tt(t,L)},F=function(t){var e=new p(t.x,t.y,t.spatialReference);return{Lat:e.getLatitude(),Long:e.getLongitude()}},H=function(t){if(t){var e=new v;e.outFields=["*"],e.where="PARK_ID IN ("+t+")";var a=pt("trails",e);a?X(a.features):M.queryFeatures(e).then(function(t){K("trails",{query:e,data:t}),X(t.features)})}},$=function(t){var e=new v;e.where="name is not null",e.orderByFields=["NAME"],"string"==typeof t&&(e.where=t);var a=pt("ids",e);a?it(a.objectIds):k.queryIds(e,function(t){G({query:e,objectIds:t}),it(t)})},J=function(t){for(var e=0;e<S.attachs.length;e++){if(r.isEqual(S.attachs[e],t))return}S.attachs.push(t)},G=function(t){for(var e=0;e<S.ids.length;e++){if(r.isEqual(t,S.ids[e]))return}S.ids.push(t)},K=function(t,e){for(var a=0;a<S[t].length;a++){var n=S[t][a];if(r.isEqual(n.query,e.query))return}S[t].push(e)},W=function(t,e){return t.queryAttachmentInfos(e)},U=function(t){var e=u(t.target),a=e.val(),r=at(a);$(r)},V=function(t,e){if(ut(t)){var a=parseInt(t),r=N.currentPage;10===a?r=Math.ceil(r/2):r*=2,N.recordsPerPage=a,vt(r)}else N.recordsPerPage=N.totalRecords,vt(1)},z=function(t,e,a){if(t.length>0)for(var r=t.length-1;r>=0;r--){var n=f.render(D(a),t[r]),i="."+e+"[data-object-id="+t[r].objectId+"] ."+e+"-map";setTimeout(function(){u(i).html(n).find(".trails-header-hidden").removeClass("trails-header-hidden")},250)}},Y=function(t,e,a,r){for(var n=0;n<e.length;n++){var i=e[n],o=gt(t.name,i);o?z(o,a,r):W(t,e[n]).then(function(e){e.length&&(J({layer:t.name,objectId:i,data:e}),z(e,a,r))})}},Q=function(t,e){var a=t.features;a=et(a.sort(rt)),a.convertLinks=function(){return function(t,e){var a=R(e(t));return a||(a=u("<div />").html(e(t)).text()),a.replace(/(http:\/\/[^\s]+)/gi,'<a href="$1" title="View more information">$1</a>')}},a.isEndorsed=function(){return function(t,e){if("NO"!==e(t))return"<a href='/Agencies/health/coalition/lhc.html' title='Learn more about the Baltimore County Health Colation'><img src='/sebin/e/t/coalitionapproved.gif' alt='This walking trail location is Health Coalition approved.' /></a>"}};var r=f.render(j,a);u(".parks").html(r);var n=Z(ot(t.features,"ID").join(",")),i=ot(t.features,"OBJECTID");H(n),i&&Y(k,i,"park","Site Map"),e&&"function"==typeof e&&e(r)},Z=function(t){return r.without(t.split(","),"")},X=function(t){t.sort(nt),u(".park-trails-nav, .trail-tabs").html("");for(var e=0;e<t.length;e++){var a=f.render(C,t[e]),r="[data-park-id='"+t[e].attributes.PARK_ID+"']",n=f.render(_,t[e]);u(".park-trails-nav",r).append(n).find("li:first").addClass("active").find("a").text("Featured Trail"),u(".trail-tabs",r).append(a).parent().find(".trails-header-hidden").removeClass("trails-header-hidden").end().find(".tab-pane:first").addClass("active")}var i=ot(t,"OBJECTID");Y(M,i,"trail","Trail Map")},tt=function(t,e){k.infoTemplate.setTitle("${NAME}");var a=t.graphic.attributes,r=a.DESC_;r.length>255&&(r=a.DESC_.substring(0,255)+"..."),k.infoTemplate.setContent(e(r)),T.infoWindow.show(t.point,T.getInfoWindowAnchor(t.point))},et=function(t){for(var e=0;e<t.length;e++){var a=F(t[e].geometry);t[e].attributes.Lat=a.Lat,t[e].attributes.Long=a.Long}return t},at=function(t){return"ZIPCODE LIKE '"+t+"%' OR UPPER(CITY) LIKE UPPER('"+t+"%') or UPPER(NAME) LIKE UPPER('%"+t+"%') AND name is not null"},rt=function(t,e){var a=t.attributes.NAME.toLowerCase(),r=e.attributes.NAME.toLowerCase();return a<r?-1:a>r?1:0},nt=function(t,e){var a=t.attributes.TRAIL_NAME.toLowerCase(),r=e.attributes.TRAIL_NAME.toLowerCase();return a<r?-1:a>r?1:0},it=function(t){if(t){Et(t);var e=yt();vt(e,window.location.hash)}else u(".parks").html("<h2>No Matching Parks</h2>")},ot=function(t,e){for(var a=[],r=0;r<t.length;r++)a.push(t[r].attributes[e]);return a},st=function(t){var e=lt(t);return Math.ceil((e+1)/N.recordsPerPage)},lt=function(t){for(var e=0;e<N.objectIds.length;e++)if(N.objectIds[e]===t)return e},dt=function(t,e){u(t).html().length;t=t.replace("#",""),document.getElementById(t).scrollIntoView()},ct=function(){u(".js-loading-message").hide()},ut=function(t){return t-0==t&&(""+t).replace(/^\s+|\s+$/g,"").length>0},ft=function(t){var e=T.getLevel(),a=T.getLayer(M.id);if(e>=15){if(void 0===a)return T.addLayer(M)}else if(a)return T.removeLayer(M)},gt=function(t,e){for(var a=0;a<S.attachs.length;a++)if(r.isEqual(e,S.attachs[a].objectId)&&r.isEqual(t,S.attachs[a].layer))return S.attachs[a].data},pt=function(t,e){for(var a=0;a<S[t].length;a++)if(r.isEqual(e,S[t][a].query))return S[t][a].data},ht=function(t){var e=u(".js-page-btn"),a=u(".page-"+t),r=u(".js-last-btn, .js-next-btn"),n=u(".js-first-btn, .js-prev-btn"),i=u(".js-first-btn, .js-last-btn, .js-prev-btn, .js-next-btn"),o=u(".paging-numbers:first").children().length;e.removeClass("active"),a.addClass("active"),t===N.totalPages()&&1!==N.totalPages()?(r.attr("disabled","disabled"),n.removeAttr("disabled")):1===t?(n.attr("disabled","disabled"),r.removeAttr("disabled"),1===o&&r.attr("disabled","disabled")):i.removeAttr("disabled")},vt=function(t,e,a){if(!(t<1||t>N.totalPages)){bt();var r=N.recordsPerPage*(parseInt(t)-1),n=r+N.recordsPerPage,i=pt("parks",d),o=N.totalPages();if(N.currentPage=t,mt(o,t),Pt(r,n,t),i)Q(i,a),ct();else{var s=function(t){K("parks",{query:d,data:t}),Q(t,function(t){ct(),e&&dt(e),a&&"function"==typeof a&&a()})},l=function(t){console.log(t)},d=new v;d.objectIds=N.objectIds.slice(r,n),d.where="name is not null",d.outFields=["*"],k.queryFeatures(d,s,l)}}},mt=function(t,e){var a,r,n="";e<=3?(a=0,r=t<5?t:5):e>t-3?(a=t-5,r=t):(a=e-3,r=e+2);for(var i=a;i<r;i++){var o=i+1;n+="<button class='btn btn-default js-page-btn page-"+o+"' id='page-"+o+"'>"+o+"</button>"}u(".paging-numbers").html(n),ht(e)},bt=function(){u(".js-loading-message").show()},Pt=function(t,e,a){var r=N.totalPages(),n=t+1+" - "+e+" of "+N.totalRecords;N.currentPage=a,N.currentPage===r&&(n=t+1+" - "+N.totalRecords+" of "+N.totalRecords),u(".page-info").html(" | Page: "+N.currentPage+" of "+r),u(".records-info").html(n)},Et=function(t,e){N={objectIds:t,totalRecords:t.length,totalPages:function(){var e=this;return Math.ceil(t.length/e.recordsPerPage)},currentRange:function(){var t=this;return(1===t.currentPage?1:(t.currentPage-1)*t.recordsPerPage+1)+" to "+(t.recordsPerPage*t.currentPage>t.totalRecords?t.totalRecords:t.recordsPerPage*t.currentPage)},currentPage:e||0,recordsPerPage:5},N.currentPage>N.totalPages()&&vt(N.currentPage-1)};u(document).on("click",".js-prev-btn",function(t){t.preventDefault(),vt(N.currentPage-1),window.location.hash=1===N.currentPage?"page-1":"page-"+N.currentPage}),u(document).on("click",".js-next-btn",function(t){t.preventDefault(),vt(N.currentPage+1),window.location.hash="page-"+N.currentPage}),u(document).on("click",".js-first-btn",function(t){t.preventDefault(),vt(1),window.location.hash="page-1"}),u(document).on("click",".js-last-btn",function(t){t.preventDefault(),vt(N.totalPages()),window.location.hash="page-"+N.totalPages()}),u(document).on("click",".js-infoWindow-more-info",x),u(document).on("click",".js-legend-toggle",function(t){t.preventDefault();var e=u(t.target),a=e.text().toLowerCase(),r=u(".map-legend"),n=u(".map-container");"show legend"===a?(r.addClass("map-legend-visible"),n.addClass("col-md-9 col-sm-9"),e.text("Hide Legend")):(r.removeClass("map-legend-visible"),n.removeClass("col-md-9 col-sm-9"),e.text("Show Legend"))}),u(document).on("click",".js-page-btn",function(t){t.preventDefault();var e=u(t.target),a=parseInt(e.text());window.location.hash=e.attr("id"),vt(a)}),u(document).on("click",".js-show-records",function(t){t.preventDefault();var e=u(t.target),a=e.text();u(".js-show-records button").removeClass("active"),e.addClass("active"),u(".js-show-records").html(e.parent().html());var r=u(".paging").children();"show all"===a.toLowerCase()?r.hide():r.show(),V(a,N.currentPage)}),u(document).on("keyup",".js-trails-filter",function(t){window.location.hash="filter",u(this).doTimeout("typing",250,function(){U(t)}),u(this).focus()}),u(document).on("click",".trail-tabs nav-tabs a",function(t){t.preventDefault(),u(this).tab("show")}),u(document).on("click",".js-clear-filter",function(t){t.preventDefault(),u(this).parent().find("input").val("").trigger("keyup")});var wt=function(){var t=window.location.hash,e=yt();if(!t)return void vt(1,t);vt(e,t)},yt=function(){var t=window.location.hash,e=1;if(t.indexOf("page")>-1&&(e=parseInt(t.split("-")[1])),t.indexOf("parkid")>-1){var a=parseInt(t.split("-")[1]);e=st(a)}return e};window.onhashchange=wt});